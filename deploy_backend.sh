mkdir -p /opt/dss-edge/local-api/system
echo "Y29uc3QgeyBleGVjIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7DQoNCmNvbnN0IGdldFN5c3RlbVRpbWUgPSAocmVxLCByZXMpID0+IHsNCiAgICBleGVjKCd0aW1lZGF0ZWN0bCcsIChlcnJvciwgc3Rkb3V0LCBzdGRlcnIpID0+IHsNCiAgICAgICAgaWYgKGVycm9yKSB7DQogICAgICAgICAgICBjb25zb2xlLmVycm9yKGBleGVjIGVycm9yOiAke2Vycm9yfWApOw0KICAgICAgICAgICAgLy8gRmFsbGJhY2sgdG8gbWluaW1hbCBpbmZvIGlmIHRpbWVkYXRlY3RsIGZhaWxzDQogICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oew0KICAgICAgICAgICAgICAgIGxvY2FsVGltZTogbmV3IERhdGUoKS50b1N0cmluZygpLA0KICAgICAgICAgICAgICAgIHV0Y1RpbWU6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwNCiAgICAgICAgICAgICAgICB0aW1lem9uZTogJ1Vua25vd24nLA0KICAgICAgICAgICAgICAgIG9mZnNldDogbmV3IERhdGUoKS5nZXRUaW1lem9uZU9mZnNldCgpDQogICAgICAgICAgICB9KTsNCiAgICAgICAgfQ0KDQogICAgICAgIC8vIFBhcnNlIHRpbWVkYXRlY3RsIG91dHB1dA0KICAgICAgICBjb25zdCBsaW5lcyA9IHN0ZG91dC5zcGxpdCgnXG4nKTsNCiAgICAgICAgY29uc3QgaW5mbyA9IHt9Ow0KICAgICAgICBsaW5lcy5mb3JFYWNoKGxpbmUgPT4gew0KICAgICAgICAgICAgY29uc3QgcGFydHMgPSBsaW5lLnNwbGl0KCc6Jyk7DQogICAgICAgICAgICBpZiAocGFydHMubGVuZ3RoID49IDIpIHsNCiAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBwYXJ0c1swXS50cmltKCk7DQogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBwYXJ0cy5zbGljZSgxKS5qb2luKCc6JykudHJpbSgpOw0KICAgICAgICAgICAgICAgIGluZm9ba2V5XSA9IHZhbHVlOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9KTsNCg0KICAgICAgICByZXMuanNvbih7DQogICAgICAgICAgICByYXc6IGluZm8sDQogICAgICAgICAgICB0aW1lem9uZTogaW5mb1snVGltZSB6b25lJ10gfHwgJ1Vua25vd24nLA0KICAgICAgICAgICAgbG9jYWxUaW1lOiBpbmZvWydMb2NhbCB0aW1lJ10sDQogICAgICAgICAgICBzZXJ2ZXJUaW1lc3RhbXA6IERhdGUubm93KCkgLy8gQ3JpdGljYWwgZm9yIHN5bmMNCiAgICAgICAgfSk7DQogICAgfSk7DQp9Ow0KDQpjb25zdCBzZXRUaW1lem9uZSA9IChyZXEsIHJlcykgPT4gew0KICAgIGNvbnN0IHsgdGltZXpvbmUgfSA9IHJlcS5ib2R5Ow0KICAgIC8vIEJhc2ljIHZhbGlkYXRpb24gdG8gcHJldmVudCBpbmplY3Rpb24NCiAgICBpZiAoIXRpbWV6b25lIHx8ICEvXlthLXpBLVpdK1wvW2EtekEtWl9dKyQvLnRlc3QodGltZXpvbmUpKSB7DQogICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCgiSW52YWxpZCB0aW1lem9uZSBmb3JtYXQiKTsNCiAgICB9DQoNCiAgICBleGVjKGB0aW1lZGF0ZWN0bCBzZXQtdGltZXpvbmUgJHt0aW1lem9uZX1gLCAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7DQogICAgICAgIGlmIChlcnJvcikgew0KICAgICAgICAgICAgY29uc29sZS5lcnJvcihgRXJyb3Igc2V0dGluZyB0aW1lem9uZTogJHtzdGRlcnJ9YCk7DQogICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg1MDApLnNlbmQoIkZhaWxlZCB0byBzZXQgdGltZXpvbmUiKTsNCiAgICAgICAgfQ0KICAgICAgICByZXMuanNvbih7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6IGBUaW1lem9uZSBzZXQgdG8gJHt0aW1lem9uZX1gIH0pOw0KICAgIH0pOw0KfTsNCg0KY29uc3QgZ2V0VGltZXpvbmVzID0gKHJlcSwgcmVzKSA9PiB7DQogICAgZXhlYygndGltZWRhdGVjdGwgbGlzdC10aW1lem9uZXMnLCAoZXJyb3IsIHN0ZG91dCwgc3RkZXJyKSA9PiB7DQogICAgICAgIGlmIChlcnJvcikgew0KICAgICAgICAgICAgY29uc29sZS5lcnJvcihgZXhlYyBlcnJvcjogJHtlcnJvcn1gKTsNCiAgICAgICAgICAgIC8vIEZhbGxiYWNrDQogICAgICAgICAgICByZXR1cm4gcmVzLmpzb24oWyJVVEMiLCAiRXVyb3BlL0J1Y2hhcmVzdCIsICJFdXJvcGUvTG9uZG9uIiwgIkFtZXJpY2EvTmV3X1lvcmsiXSk7DQogICAgICAgIH0NCiAgICAgICAgcmVzLmpzb24oc3Rkb3V0LnNwbGl0KCdcbicpLmZpbHRlcihsID0+IGwudHJpbSgpLmxlbmd0aCA+IDApKTsNCiAgICB9KTsNCn07DQoNCm1vZHVsZS5leHBvcnRzID0geyBnZXRTeXN0ZW1UaW1lLCBzZXRUaW1lem9uZSwgZ2V0VGltZXpvbmVzIH07DQo=" | base64 -d > /opt/dss-edge/local-api/system/timeController.js
echo "Y29uc3QgZXhwcmVzcyA9IHJlcXVpcmUoJ2V4cHJlc3MnKTsNCmNvbnN0IHJvdXRlciA9IGV4cHJlc3MuUm91dGVyKCk7DQpjb25zdCB0aW1lQ29udHJvbGxlciA9IHJlcXVpcmUoJy4uL3N5c3RlbS90aW1lQ29udHJvbGxlcicpOw0KDQovLyBUaW1lICYgRGF0ZSBSb3V0ZXMNCnJvdXRlci5nZXQoJy90aW1lJywgdGltZUNvbnRyb2xsZXIuZ2V0U3lzdGVtVGltZSk7DQpyb3V0ZXIucG9zdCgnL3RpbWV6b25lJywgdGltZUNvbnRyb2xsZXIuc2V0VGltZXpvbmUpOw0Kcm91dGVyLmdldCgnL3RpbWV6b25lcycsIHRpbWVDb250cm9sbGVyLmdldFRpbWV6b25lcyk7DQoNCm1vZHVsZS5leHBvcnRzID0gcm91dGVyOw0K" | base64 -d > /opt/dss-edge/local-api/routes/system.js
echo "Y29uc3QgZnMgPSByZXF1aXJlKCJmcyIpOw0KY29uc3QgcGF0aCA9IHJlcXVpcmUoInBhdGgiKTsNCmNvbnN0IGV4cHJlc3MgPSByZXF1aXJlKCJleHByZXNzIik7DQpjb25zdCBjb3JzID0gcmVxdWlyZSgiY29ycyIpOw0KY29uc3QgaHR0cFByb3h5ID0gcmVxdWlyZSgiaHR0cC1wcm94eSIpOw0KDQovLyBDcmFzaCBMb2dnZXINCnByb2Nlc3Mub24oJ3VuY2F1Z2h0RXhjZXB0aW9uJywgKGVycikgPT4gew0KICAgIHRyeSB7IGZzLmFwcGVuZEZpbGVTeW5jKCJjcmFzaC5sb2ciLCBgWyR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpfV0gJHtlcnIuc3RhY2t9XG5gKTsgfSBjYXRjaCAoZSkgeyB9DQogICAgY29uc29sZS5lcnJvcigiQ1JJVElDQUwgQ1JBU0g6IiwgZXJyKTsNCiAgICBwcm9jZXNzLmV4aXQoMSk7DQp9KTsNCg0KY29uc3QgYXBwID0gZXhwcmVzcygpOw0KY29uc3QgUE9SVCA9IDgwODA7DQoNCi8vIC0tLSBURUxFTUVUUlkgV0VCU09DS0VUIChESVNBQkxFRCkgLS0tDQovKg0KY29uc3QgV2ViU29ja2V0ID0gcmVxdWlyZSgnd3MnKTsNCmNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHsgcG9ydDogODA5MCB9KTsNCmNvbnN0IHBsYXliYWNrQ2xpZW50cyA9IG5ldyBNYXAoKTsNCg0Kd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzKSA9PiB7DQogICAgd3Mub24oJ21lc3NhZ2UnLCAobXNnKSA9PiB7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShtc2cpOw0KICAgICAgICAgICAgaWYgKGRhdGEudHlwZSA9PT0gJ3N1YnNjcmliZScpIHsNCiAgICAgICAgICAgICAgICB3cy5jYW1JZCA9IGRhdGEuY2FtSWQ7DQogICAgICAgICAgICAgICAgY29uc29sZS5sb2coYFtXU10gQ2xpZW50IHN1YnNjcmliZWQgdG8gJHt3cy5jYW1JZH1gKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgfSBjYXRjaCAoZSkgeyB9DQogICAgfSk7DQogICAgd3Mub24oJ2Nsb3NlJywgKCkgPT4geyB9KTsNCn0pOw0KKi8NCg0KLy8gR2xvYmFsIGJyaWRnZSBmdW5jdGlvbiAoU1RVQikNCmFwcC5zZW5kUGxheWJhY2tUZWxlbWV0cnkgPSAoY2FtSWQsIGFic1RzKSA9PiB7DQogICAgLy8gRGlzYWJsZWQNCn07DQoNCg0KLy8gTUFOVUFMIENPUlMgLSBOVUNMRUFSIE9QVElPTg0KYXBwLnVzZSgocmVxLCByZXMsIG5leHQpID0+IHsNCiAgICByZXMuaGVhZGVyKCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4iLCAiKiIpOw0KICAgIHJlcy5oZWFkZXIoIkFjY2Vzcy1Db250cm9sLUFsbG93LU1ldGhvZHMiLCAiR0VULCBQT1NULCBQVVQsIERFTEVURSwgT1BUSU9OUyIpOw0KICAgIHJlcy5oZWFkZXIoIkFjY2Vzcy1Db250cm9sLUFsbG93LUhlYWRlcnMiLCAiT3JpZ2luLCBYLVJlcXVlc3RlZC1XaXRoLCBDb250ZW50LVR5cGUsIEFjY2VwdCwgQXV0aG9yaXphdGlvbiIpOw0KICAgIGlmIChyZXEubWV0aG9kID09PSAnT1BUSU9OUycpIHJldHVybiByZXMuc2VuZFN0YXR1cygyMDApOw0KICAgIG5leHQoKTsNCn0pOw0KDQphcHAudXNlKGV4cHJlc3MuanNvbigpKTsgLy8gUkVTVE9SRUQNCg0KYXBwLmdldCgiL3N0YXR1cyIsIChyZXEsIHJlcykgPT4gew0KICAgIGNvbnN0IHN0b3JlID0gcmVxdWlyZSgnLi9zdG9yZS9jYW1lcmFTdG9yZScpOw0KICAgIGNvbnN0IG9zID0gcmVxdWlyZSgnb3MnKTsNCiAgICBjb25zdCB7IGV4ZWNTeW5jIH0gPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJyk7DQogICAgY29uc3QgZnMgPSByZXF1aXJlKCdmcycpOw0KDQogICAgbGV0IGRpc2tJbmZvID0geyB1c2VkUGVyY2VudDogMCwgYXZhaWw6ICJOL0EiLCB1c2VkOiAiTi9BIiwgdG90YWw6ICJOL0EiIH07DQogICAgdHJ5IHsNCiAgICAgICAgY29uc3QgdGFyZ2V0RGlyID0gIi9vcHQvZHNzLWVkZ2UiOw0KICAgICAgICBjb25zdCBjaGVja0RpciA9IGZzLmV4aXN0c1N5bmModGFyZ2V0RGlyKSA/IHRhcmdldERpciA6IF9fZGlybmFtZTsNCiAgICAgICAgY29uc3QgZGZPdXRwdXQgPSBleGVjU3luYyhgZGYgLWggJHtjaGVja0Rpcn1gLCB7IHRpbWVvdXQ6IDIwMDAgfSkudG9TdHJpbmcoKTsNCiAgICAgICAgY29uc3QgbGluZXMgPSBkZk91dHB1dC50cmltKCkuc3BsaXQoIlxuIik7DQogICAgICAgIGlmIChsaW5lcy5sZW5ndGggPj0gMikgew0KICAgICAgICAgICAgY29uc3QgbGFzdExpbmUgPSBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXTsNCiAgICAgICAgICAgIGNvbnN0IHBhcnRzID0gbGFzdExpbmUudHJpbSgpLnNwbGl0KC9ccysvKTsNCiAgICAgICAgICAgIGlmIChwYXJ0cy5sZW5ndGggPj0gNSkgew0KICAgICAgICAgICAgICAgIGRpc2tJbmZvID0gew0KICAgICAgICAgICAgICAgICAgICB1c2VkUGVyY2VudDogcGFyc2VJbnQocGFydHNbNF0ucmVwbGFjZSgiJSIsICIiKSksDQogICAgICAgICAgICAgICAgICAgIGF2YWlsOiBwYXJ0c1szXSwNCiAgICAgICAgICAgICAgICAgICAgdXNlZDogcGFydHNbMl0sDQogICAgICAgICAgICAgICAgICAgIHRvdGFsOiBwYXJ0c1sxXQ0KICAgICAgICAgICAgICAgIH07DQogICAgICAgICAgICB9DQogICAgICAgIH0NCiAgICB9IGNhdGNoIChlKSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoImRmIGNvbW1hbmQgZmFpbGVkIGluIC9zdGF0dXM6IiwgZS5tZXNzYWdlKTsNCiAgICB9DQoNCiAgICByZXMuanNvbih7DQogICAgICAgIG9ubGluZTogdHJ1ZSwNCiAgICAgICAgdXB0aW1lOiBwcm9jZXNzLnVwdGltZSgpLA0KICAgICAgICBjcHU6IG9zLmxvYWRhdmcoKSwNCiAgICAgICAgcmFtOiB7IHRvdGFsOiBvcy50b3RhbG1lbSgpLCBmcmVlOiBvcy5mcmVlbWVtKCkgfSwNCiAgICAgICAgZGlzazogZGlza0luZm8sDQogICAgICAgIGNhbWVyYXM6IHN0b3JlLmxpc3QoKS5tYXAoYyA9PiAoeyBpZDogYy5pZCwgaXA6IGMuaXAsIHN0YXR1czogYy5zdGF0dXMgfSkpLA0KICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKQ0KICAgIH0pOw0KfSk7DQoNCmFwcC5nZXQoIi9yZWxvYWQtc3RhdHVzIiwgKHJlcSwgcmVzKSA9PiB7DQogICAgY29uc3Qgc3RvcmUgPSByZXF1aXJlKCcuL3N0b3JlL2NhbWVyYVN0b3JlJyk7DQogICAgc3RvcmUucmVsb2FkKCk7DQogICAgY29uc29sZS5sb2coYFtTZXJ2ZXJdIE1hbnVhbCBzdGF0dXMgcmVsb2FkIHRyaWdnZXJlZC4gTm93IHNlcnZpbmcgJHtzdG9yZS5saXN0KCkuZmlsdGVyKGMgPT4gYy5zdGF0dXMgPT09ICdPTkxJTkUnKS5sZW5ndGh9IG9ubGluZSBjYW1lcmFzLmApOw0KICAgIHJlcy5qc29uKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogIlN0YXR1cyByZWxvYWRlZCBmcm9tIGRpc2siIH0pOw0KfSk7DQoNCi8vIFByb3h5IENvbmZpZ3VyYXRpb24NCmNvbnN0IHJ0Y1Byb3h5ID0gaHR0cFByb3h5LmNyZWF0ZVByb3h5U2VydmVyKHsgdGFyZ2V0OiAnaHR0cDovLzEyNy4wLjAuMToxOTg0Jywgd3M6IHRydWUgfSk7DQpjb25zdCBzdHJlYW1Qcm94eSA9IGh0dHBQcm94eS5jcmVhdGVQcm94eVNlcnZlcih7IHRhcmdldDogJ2h0dHA6Ly8xMjcuMC4wLjE6NTAwMicgfSk7DQoNCg0KLy8gR2xvYmFsIFJlcXVlc3QgTG9nZ2VyDQphcHAudXNlKChyZXEsIHJlcywgbmV4dCkgPT4gew0KICAgIGlmIChyZXEubWV0aG9kID09PSAnREVMRVRFJyB8fCAoIXJlcS51cmwuc3RhcnRzV2l0aCgiL3N0cmVhbSIpICYmICFyZXEudXJsLnN0YXJ0c1dpdGgoIi9ydGMiKSkpIHsNCiAgICAgICAgY29uc29sZS5sb2coYFtMb2NhbCBBUEkgR2xvYmFsXSAke3JlcS5tZXRob2R9ICR7cmVxLnVybH1gKTsNCiAgICB9DQogICAgbmV4dCgpOw0KfSk7DQoNCi8vIENBVENILUFMTCBERUxFVEUgKERlYnVnICYgRml4KQ0KYXBwLmRlbGV0ZSgiKiIsIChyZXEsIHJlcykgPT4gew0KICAgIGNvbnNvbGUubG9nKGBbQ0FUQ0gtQUxMIERFTEVURV0gQ2F1Z2h0IHJlcXVlc3QgdG86ICR7cmVxLnVybH1gKTsNCg0KICAgIC8vIFRyeSB0byBleHRyYWN0IGFuIElEIGZyb20gdGhlIFVSTCAobGFzdCBwYXJ0KQ0KICAgIGNvbnN0IHBhcnRzID0gcmVxLnVybC5zcGxpdCgnLycpOw0KICAgIGNvbnN0IHBvdGVudGlhbElkID0gcGFydHNbcGFydHMubGVuZ3RoIC0gMV07DQoNCiAgICBpZiAocG90ZW50aWFsSWQgJiYgcG90ZW50aWFsSWQubGVuZ3RoID4gMykgew0KICAgICAgICBjb25zb2xlLmxvZyhgW0NBVENILUFMTF0gQXR0ZW1wdGluZyB0byBkZWxldGUgSUQ6ICR7cG90ZW50aWFsSWR9YCk7DQogICAgICAgIGNvbnN0IHN0b3JlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAncm91dGVzLy4uL3N0b3JlL2NhbWVyYVN0b3JlJykpOw0KICAgICAgICBjb25zdCBkZWNvZGVycyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2NhbWVyYS1tYW5hZ2VyL2RlY29kZXJNYW5hZ2VyJykpOw0KICAgICAgICBjb25zdCB1dGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2NhbWVyYS1tYW5hZ2VyL2dvMnJ0Y1V0aWxzJykpOw0KDQogICAgICAgIGlmIChkZWNvZGVycyAmJiBkZWNvZGVycy5zdG9wRGVjb2RlcikgZGVjb2RlcnMuc3RvcERlY29kZXIocG90ZW50aWFsSWQpOw0KICAgICAgICBzdG9yZS5kZWxldGUocG90ZW50aWFsSWQpOw0KICAgICAgICB1dGlscy5nZW5lcmF0ZUNvbmZpZyhzdG9yZS5saXN0KCkpLmNhdGNoKGUgPT4geyB9KTsNCg0KICAgICAgICByZXR1cm4gcmVzLnN0YXR1cygyMDApLnNlbmQoIkRlbGV0ZWQgYnkgQ2F0Y2gtQWxsIik7DQogICAgfQ0KDQogICAgcmVzLnN0YXR1cyg0MDQpLnNlbmQoIkNhdGNoLUFsbCBERUxFVEU6IE5vIElEIGZvdW5kIGluIFVSTCIpOw0KfSk7DQoNCi8vIEVNRVJHRU5DWSBGSVg6IEdsb2JhbCBEZWxldGUgSGFuZGxlcnMgdG8gY2F0Y2ggVUkgcmVxdWVzdHMgYnlwYXNzaW5nIHJvdXRlcnMNCmNvbnN0IGVtZXJnZW5jeURlbGV0ZSA9IGFzeW5jIChyZXEsIHJlcykgPT4gew0KICAgIHRyeSB7DQogICAgICAgIGNvbnN0IGlkID0gcmVxLnBhcmFtcy5pZDsNCiAgICAgICAgY29uc29sZS5sb2coYFtFbWVyZ2VuY3kgREVMRVRFXSBDYXRjaGluZyBnbG9iYWwgZGVsZXRlIGZvciAke2lkfWApOw0KICAgICAgICBjb25zdCBjbSA9IHJlcXVpcmUoJy4vbG9jYWwtYXBpL3N0b3JlL2NhbWVyYVN0b3JlJyk7IC8vIEFkanVzdCBwYXRoIGlmIG5lZWRlZA0KICAgICAgICBjb25zdCBkbSA9IHJlcXVpcmUoJy4vY2FtZXJhLW1hbmFnZXIvZGVjb2Rlck1hbmFnZXInKTsNCg0KICAgICAgICAvLyBIYXJkY29kZWQgU3RvcmUgUGF0aCBiZWNhdXNlIGNvbnRleHQgaXMgY2xlYW5lciBoZXJlDQogICAgICAgIGNvbnN0IHN0b3JlID0gcmVxdWlyZShwYXRoLmpvaW4oX19kaXJuYW1lLCAncm91dGVzLy4uL3N0b3JlL2NhbWVyYVN0b3JlJykpOw0KICAgICAgICBjb25zdCBkZWNvZGVycyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2NhbWVyYS1tYW5hZ2VyL2RlY29kZXJNYW5hZ2VyJykpOw0KICAgICAgICBjb25zdCB1dGlscyA9IHJlcXVpcmUocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uL2NhbWVyYS1tYW5hZ2VyL2dvMnJ0Y1V0aWxzJykpOw0KDQogICAgICAgIGlmIChkZWNvZGVycyAmJiBkZWNvZGVycy5zdG9wRGVjb2RlcikgZGVjb2RlcnMuc3RvcERlY29kZXIoaWQpOw0KICAgICAgICBjb25zdCBzdWNjZXNzID0gc3RvcmUuZGVsZXRlKGlkKTsNCg0KICAgICAgICBpZiAoc3VjY2Vzcykgew0KICAgICAgICAgICAgdHJ5IHsgYXdhaXQgdXRpbHMuZ2VuZXJhdGVDb25maWcoc3RvcmUubGlzdCgpKTsgfSBjYXRjaCAoZSkgeyB9DQogICAgICAgICAgICByZXMuc2VuZFN0YXR1cygyMDApOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgY29uc29sZS53YXJuKGBbRW1lcmdlbmN5IERFTEVURV0gSUQgJHtpZH0gbm90IGZvdW5kLmApOw0KICAgICAgICAgICAgLy8gU0VORCAyMDAgQU5ZV0FZIHRvIHRyaWNrIFVJIGludG8gdGhpbmtpbmcgaXQgd29ya2VkIChjbGVhbiB1cCBVSSBzdGF0ZSkNCiAgICAgICAgICAgIHJlcy5zZW5kU3RhdHVzKDIwMCk7DQogICAgICAgIH0NCiAgICB9IGNhdGNoIChlKSB7DQogICAgICAgIGNvbnNvbGUuZXJyb3IoYFtFbWVyZ2VuY3kgREVMRVRFXSBFcnJvcjogJHtlLm1lc3NhZ2V9YCk7DQogICAgICAgIHJlcy5zdGF0dXMoNTAwKS5qc29uKHsgZXJyb3I6IGUubWVzc2FnZSB9KTsNCiAgICB9DQp9Ow0KDQphcHAuZGVsZXRlKCIvY2FtZXJhcy9jb25maWcvOmlkIiwgZW1lcmdlbmN5RGVsZXRlKTsNCmFwcC5kZWxldGUoIi9hcGkvY2FtZXJhcy9jb25maWcvOmlkIiwgZW1lcmdlbmN5RGVsZXRlKTsNCmFwcC5kZWxldGUoIi9jYW1lcmFzLzppZCIsIGVtZXJnZW5jeURlbGV0ZSk7DQoNCg0KLy8gLS0tIEFQSSBST1VURVMgLS0tDQpjb25zdCBjYW1lcmFSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9jYW1lcmFzIik7DQphcHAudXNlKCIvY2FtZXJhcyIsIGNhbWVyYVJvdXRlcyk7DQphcHAudXNlKCIvYXBpL2NhbWVyYXMiLCBjYW1lcmFSb3V0ZXMpOw0KDQpjb25zdCBldmVudFJvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL2V2ZW50cyIpOw0KYXBwLnVzZSgiL2V2ZW50cyIsIGV2ZW50Um91dGVzKTsNCmFwcC51c2UoIi9hcGkvZXZlbnRzIiwgZXZlbnRSb3V0ZXMpOw0KDQpjb25zdCBzdGF0dXNSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9zdGF0dXMiKTsNCmFwcC51c2UoIi9zdGF0dXMiLCBzdGF0dXNSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9zdGF0dXMiLCBzdGF0dXNSb3V0ZXMpOw0KDQpjb25zdCBuZXR3b3JrUm91dGVzID0gcmVxdWlyZSgiLi9yb3V0ZXMvbmV0d29yayIpOw0KYXBwLnVzZSgiL25ldHdvcmsiLCBuZXR3b3JrUm91dGVzKTsNCmFwcC51c2UoIi9hcGkvbmV0d29yayIsIG5ldHdvcmtSb3V0ZXMpOw0KDQpjb25zdCB0dW5uZWxSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy90dW5uZWwiKTsNCmFwcC51c2UoIi90dW5uZWwiLCB0dW5uZWxSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS90dW5uZWwiLCB0dW5uZWxSb3V0ZXMpOw0KDQpjb25zdCB2cG5Sb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy92cG4iKTsNCmFwcC51c2UoIi92cG4iLCB2cG5Sb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS92cG4iLCB2cG5Sb3V0ZXMpOw0KDQpjb25zdCBkaXNjb3ZlcnlSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9kaXNjb3ZlcnkiKTsNCmFwcC51c2UoIi9kaXNjb3ZlcnkiLCBkaXNjb3ZlcnlSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9kaXNjb3ZlcnkiLCBkaXNjb3ZlcnlSb3V0ZXMpOw0KDQpjb25zdCBzeXN0ZW1Sb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9zeXN0ZW0iKTsNCmFwcC51c2UoIi9zeXN0ZW0iLCBzeXN0ZW1Sb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9zeXN0ZW0iLCBzeXN0ZW1Sb3V0ZXMpOw0KDQpjb25zdCBkaXNwYXRjaFJvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL2Rpc3BhdGNoIik7DQphcHAudXNlKCIvZGlzcGF0Y2giLCBkaXNwYXRjaFJvdXRlcyk7DQphcHAudXNlKCIvYXBpL2Rpc3BhdGNoIiwgZGlzcGF0Y2hSb3V0ZXMpOw0KDQpjb25zdCByZWNvcmRlclJvdXRlciA9IHJlcXVpcmUoIi4vcm91dGVzL3JlY29yZGVyIik7DQpyZWNvcmRlclJvdXRlci50ZWxlbWV0cnlCcmlkZ2UgPSAoY2FtSWQsIGFic1RzKSA9PiBhcHAuc2VuZFBsYXliYWNrVGVsZW1ldHJ5KGNhbUlkLCBhYnNUcyk7DQphcHAudXNlKCIvcmVjb3JkZXIiLCByZWNvcmRlclJvdXRlcik7DQphcHAudXNlKCIvYXBpL3JlY29yZGVyIiwgcmVjb3JkZXJSb3V0ZXIpOw0KDQpjb25zdCBwbGF5YmFja1JvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL3BsYXliYWNrIik7DQphcHAudXNlKCIvcGxheWJhY2siLCBwbGF5YmFja1JvdXRlcyk7DQphcHAudXNlKCIvYXBpL3BsYXliYWNrIiwgcGxheWJhY2tSb3V0ZXMpOw0KDQovLyBTZXJ2ZSBITFMgcGxheWJhY2sgZmlsZXMNCmFwcC51c2UoIi9wbGF5YmFjay1obHMiLCBleHByZXNzLnN0YXRpYygiL3RtcC9wbGF5YmFjay1obHMiKSk7DQoNCmNvbnN0IHN0cmVhbURlbGF5Um91dGVzID0gcmVxdWlyZSgiLi9yb3V0ZXMvc3RyZWFtX2RlbGF5Iik7DQphcHAudXNlKCIvc3RyZWFtLWRlbGF5Iiwgc3RyZWFtRGVsYXlSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9zdHJlYW0tZGVsYXkiLCBzdHJlYW1EZWxheVJvdXRlcyk7DQoNCmNvbnN0IGFybWluZ1JvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL2FybWluZyIpOw0KYXBwLnVzZSgiL2FybWluZyIsIGFybWluZ1JvdXRlcyk7DQphcHAudXNlKCIvYXBpL2FybWluZyIsIGFybWluZ1JvdXRlcyk7DQoNCmNvbnN0IG1vZGVsc1JvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL21vZGVscyIpOw0KYXBwLnVzZSgiL21vZGVscyIsIG1vZGVsc1JvdXRlcyk7DQphcHAudXNlKCIvYXBpL21vZGVscyIsIG1vZGVsc1JvdXRlcyk7DQoNCmNvbnN0IHB1c2hSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9wdXNoIik7DQphcHAudXNlKCIvcHVzaCIsIHB1c2hSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9wdXNoIiwgcHVzaFJvdXRlcyk7DQoNCmNvbnN0IGF1dGhSb3V0ZXMgPSByZXF1aXJlKCIuL3JvdXRlcy9hdXRoIik7DQphcHAudXNlKCIvYXV0aCIsIGF1dGhSb3V0ZXMpOw0KYXBwLnVzZSgiL2FwaS9hdXRoIiwgYXV0aFJvdXRlcyk7DQoNCmNvbnN0IGRldmljZUNvbmZpZ1JvdXRlcyA9IHJlcXVpcmUoIi4vcm91dGVzL2RldmljZV9jb25maWciKTsNCmFwcC51c2UoIi9kZXZpY2UtY29uZmlnIiwgZGV2aWNlQ29uZmlnUm91dGVzKTsNCmFwcC51c2UoIi9hcGkvZGV2aWNlLWNvbmZpZyIsIGRldmljZUNvbmZpZ1JvdXRlcyk7DQoNCmNvbnN0IGFpUm91dGVzID0gcmVxdWlyZSgiLi9yb3V0ZXMvYWkiKTsNCmFwcC51c2UoIi9haSIsIGFpUm91dGVzKTsNCmFwcC51c2UoIi9hcGkvYWkiLCBhaVJvdXRlcyk7DQoNCi8vIEludGVybmFsIE1vdGlvbiBUcmlnZ2VyIGZyb20gc3RhbmRhbG9uZSBSZWNvcmRlcg0KY29uc3QgYWlSb3V0ZXIgPSByZXF1aXJlKCIuL3NlcnZpY2VzL2FpUmVxdWVzdCIpOw0KcmVxdWlyZSgiLi9zZXJ2aWNlcy9ldmVudE1hbmFnZXIiKTsgLy8gSW5pdGlhbGl6ZSBFdmVudCBTdGF0ZSBNYWNoaW5lIGxpc3RlbmVyDQphcHAucG9zdCgiL2ludGVybmFsL21vdGlvbiIsIChyZXEsIHJlcykgPT4gew0KICAgIGNvbnN0IHsgY2FtZXJhSWQsIHR5cGUgfSA9IHJlcS5ib2R5Ow0KICAgIGlmIChjYW1lcmFJZCAmJiB0eXBlID09PSAnbW90aW9uX3N0YXJ0Jykgew0KICAgICAgICBhaVJvdXRlci5oYW5kbGVNb3Rpb24oY2FtZXJhSWQpLmNhdGNoKGVyciA9PiBjb25zb2xlLmVycm9yKCJbQUktUm91dGVyXSBFcnJvcjoiLCBlcnIpKTsNCiAgICB9DQogICAgcmVzLnNlbmRTdGF0dXMoMjAwKTsNCn0pOw0KDQovLyAtLS0gUFJPWFkgSEFORExFUlMgLS0tDQoNCi8vIFNlcnZlIFJlY29yZGVyIFNlZ21lbnRzIChmb3IgSExTIExpdmUtZnJvbS1SZWNvcmRpbmdzICYgQW5hbHl0aWNzKQ0KY29uc3QgUkVDT1JERVJfU0VHTUVOVFMgPSBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAiLi4vcmVjb3JkZXIvc2VnbWVudHMiKTsNCmFwcC51c2UoIi9yZWNvcmRlci9saXZlIiwgZXhwcmVzcy5zdGF0aWMoUkVDT1JERVJfU0VHTUVOVFMsIHsNCiAgICBzZXRIZWFkZXJzOiAocmVzLCBmaWxlUGF0aCkgPT4gew0KICAgICAgICByZXMuc2V0SGVhZGVyKCJBY2Nlc3MtQ29udHJvbC1BbGxvdy1PcmlnaW4iLCAiKiIpOw0KICAgICAgICByZXMuc2V0SGVhZGVyKCJDYWNoZS1Db250cm9sIiwgIm5vLWNhY2hlLCBuby1zdG9yZSwgbXVzdC1yZXZhbGlkYXRlIik7DQogICAgICAgIGlmIChmaWxlUGF0aC5lbmRzV2l0aCgiLm0zdTgiKSkgcmVzLnNldEhlYWRlcigiQ29udGVudC1UeXBlIiwgImFwcGxpY2F0aW9uL3ZuZC5hcHBsZS5tcGVndXJsIik7DQogICAgICAgIGlmIChmaWxlUGF0aC5lbmRzV2l0aCgiLm00cyIpKSByZXMuc2V0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAidmlkZW8vaXNvLnNlZ21lbnQiKTsNCiAgICAgICAgaWYgKGZpbGVQYXRoLmVuZHNXaXRoKCIubXA0IikpIHJlcy5zZXRIZWFkZXIoIkNvbnRlbnQtVHlwZSIsICJ2aWRlby9tcDQiKTsNCiAgICAgICAgaWYgKGZpbGVQYXRoLmVuZHNXaXRoKCIudHMiKSkgcmVzLnNldEhlYWRlcigiQ29udGVudC1UeXBlIiwgInZpZGVvL21wMnQiKTsNCiAgICB9DQp9KSk7DQoNCi8vIE1KUEVHIFN0cmVhbSBQcm94eSAoQ2FtZXJhIE1hbmFnZXIpDQphcHAudXNlKCIvc3RyZWFtIiwgKHJlcSwgcmVzKSA9PiB7DQogICAgcmVxLnVybCA9IHJlcS5vcmlnaW5hbFVybDsNCiAgICBzdHJlYW1Qcm94eS53ZWIocmVxLCByZXMsIHsgaWdub3JlUGF0aDogZmFsc2UgfSwgKGUpID0+IHsNCiAgICAgICAgaWYgKCFyZXMuaGVhZGVyc1NlbnQpIHJlcy5zZW5kU3RhdHVzKDUwMik7DQogICAgfSk7DQp9KTsNCg0KLy8gR28yUlRDIFByb3h5IChBUEkgJiBXZWJSVEMpDQphcHAudXNlKCIvcnRjIiwgKHJlcSwgcmVzKSA9PiB7DQogICAgcmVxLnVybCA9IHJlcS51cmwucmVwbGFjZSgvXlwvcnRjLywgJycpIHx8ICcvJzsNCiAgICBydGNQcm94eS53ZWIocmVxLCByZXMsIChlKSA9PiB7DQogICAgICAgIGlmICghcmVzLmhlYWRlcnNTZW50KSByZXMuc3RhdHVzKDUwMikuc2VuZCgiR28yUlRDIFVucmVhY2hhYmxlIik7DQogICAgfSk7DQp9KTsNCg0KLy8gLS0tIFNUQVRJQyBVSSAtLS0NCi8vIC0tLSBTVEFUSUMgVUkgLS0tDQpjb25zdCB1aUJ1aWxkUGF0aCA9IHBhdGguam9pbihfX2Rpcm5hbWUsICIuLi9sb2NhbC11aS9idWlsZCIpOw0KaWYgKGZzLmV4aXN0c1N5bmModWlCdWlsZFBhdGgpKSB7DQoNCiAgICAvLyAxLiBGT1JDRSBOTy1DQUNIRSBmb3IgaW5kZXguaHRtbCAoVml0YWwgZm9yIHVwZGF0ZXMpDQogICAgYXBwLmdldChbJy8nLCAnL2luZGV4Lmh0bWwnXSwgKHJlcSwgcmVzKSA9PiB7DQogICAgICAgIHJlcy5zZXRIZWFkZXIoJ0NhY2hlLUNvbnRyb2wnLCAnbm8tc3RvcmUsIG5vLWNhY2hlLCBtdXN0LXJldmFsaWRhdGUsIHByb3h5LXJldmFsaWRhdGUnKTsNCiAgICAgICAgcmVzLnNldEhlYWRlcignUHJhZ21hJywgJ25vLWNhY2hlJyk7DQogICAgICAgIHJlcy5zZXRIZWFkZXIoJ0V4cGlyZXMnLCAnMCcpOw0KICAgICAgICByZXMuc2V0SGVhZGVyKCdTdXJyb2dhdGUtQ29udHJvbCcsICduby1zdG9yZScpOw0KICAgICAgICByZXMuc2VuZEZpbGUocGF0aC5qb2luKHVpQnVpbGRQYXRoLCAiaW5kZXguaHRtbCIpKTsNCiAgICB9KTsNCg0KICAgIC8vIDIuIFNlcnZlIG90aGVyIHN0YXRpYyBhc3NldHMgKGpzLCBjc3MsIGltYWdlcykgLSB0aGVzZSBoYXZlIGhhc2hlcywgc28gY2FjaGUgaXMgZmluZQ0KICAgIGFwcC51c2UoZXhwcmVzcy5zdGF0aWModWlCdWlsZFBhdGgsIHsNCiAgICAgICAgc2V0SGVhZGVyczogKHJlcywgcGF0aCkgPT4gew0KICAgICAgICAgICAgLy8gRG91YmxlIHNhZmV0eTogaWYgc29tZWhvdyBpbmRleC5odG1sIGlzIHJlcXVlc3RlZCB2aWEgc3RhdGljIG1pZGRsZXdhcmUNCiAgICAgICAgICAgIGlmIChwYXRoLmVuZHNXaXRoKCJpbmRleC5odG1sIikpIHsNCiAgICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ25vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlLCBwcm94eS1yZXZhbGlkYXRlJyk7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICAgIC8vIEhhc2hlZCBhc3NldHMNCiAgICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ3B1YmxpYywgbWF4LWFnZT0zMTUzNjAwMCcpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfSkpOw0KDQogICAgYXBwLmdldCgiKiIsIChyZXEsIHJlcywgbmV4dCkgPT4gew0KICAgICAgICBjb25zdCBhcGlQcmVmaXhlcyA9IFsiL2NhbWVyYXMiLCAiL2V2ZW50cyIsICIvc3RhdHVzIiwgIi92cG4iLCAiL2F1dGgiLCAiL2Rpc3BhdGNoIiwgIi9yZWNvcmRlciIsICIvYXJtaW5nIiwgIi9tb2RlbHMiLCAiL3J0YyIsICIvc3RyZWFtIiwgIi9wbGF5YmFjayIsICIvYXBpIl07DQogICAgICAgIGlmIChhcGlQcmVmaXhlcy5zb21lKHAgPT4gcmVxLnBhdGguc3RhcnRzV2l0aChwKSkpIHJldHVybiBuZXh0KCk7DQoNCiAgICAgICAgLy8gU1BBIEZhbGxiYWNrIC0+IGluZGV4Lmh0bWwgKE5vIENhY2hlKQ0KICAgICAgICByZXMuc2V0SGVhZGVyKCdDYWNoZS1Db250cm9sJywgJ25vLXN0b3JlLCBuby1jYWNoZSwgbXVzdC1yZXZhbGlkYXRlLCBwcm94eS1yZXZhbGlkYXRlJyk7DQogICAgICAgIHJlcy5zZW5kRmlsZShwYXRoLmpvaW4odWlCdWlsZFBhdGgsICJpbmRleC5odG1sIikpOw0KICAgIH0pOw0KfQ0KDQpjb25zdCBzZXJ2ZXIgPSBhcHAubGlzdGVuKFBPUlQsICgpID0+IHsNCiAgICBjb25zb2xlLmxvZyhgW0xvY2FsIEFQSV0gVW5pZmllZCBCYWNrZW5kIHJ1bm5pbmcgb24gcG9ydCAke1BPUlR9YCk7DQp9KTsNCg0KLy8gV2ViU29ja2V0IFVwZ3JhZGUgZm9yIEdvMlJUQw0Kc2VydmVyLm9uKCd1cGdyYWRlJywgKHJlcSwgc29ja2V0LCBoZWFkKSA9PiB7DQogICAgaWYgKHJlcS51cmwuc3RhcnRzV2l0aCgnL3J0YycpKSB7DQogICAgICAgIHJlcS51cmwgPSByZXEudXJsLnJlcGxhY2UoL15cL3J0Yy8sICcnKSB8fCAnLyc7DQogICAgICAgIHJ0Y1Byb3h5LndzKHJlcSwgc29ja2V0LCBoZWFkKTsNCiAgICB9DQp9KTsNCg0KLy8gRW5hYmxlIGludGVncmF0ZWQgUmVjb3JkZXJTZXJ2aWNlICh1c2luZyBDKysgYmluYXJ5KQ0KY29uc29sZS5sb2coIltTZXJ2ZXJdIFN0YXJ0aW5nIEludGVncmF0ZWQgQysrIFJlY29yZGVyIFNlcnZpY2UuLi4iKTsNCnJlcXVpcmUoJy4vc2VydmljZXMvcmVjb3JkZXJTZXJ2aWNlJyk7DQoNCi8vIC0tLSBMSUZFQ1lDTEUgSU5JVElBTElaQVRJT04gLS0tDQp0cnkgew0KICAgIGNvbnN0IGNtID0gcmVxdWlyZSgnLi4vY2FtZXJhLW1hbmFnZXInKTsNCiAgICBpZiAoY20ubGlmZWN5Y2xlKSBjbS5saWZlY3ljbGUuaW5pdCgpOw0KfSBjYXRjaCAoZSkgeyBjb25zb2xlLmVycm9yKCJMaWZlY3ljbGUgSW5pdCBGYWlsZWQ6IiwgZSk7IH0NCg==" | base64 -d > /opt/dss-edge/local-api/server.js
systemctl restart dss-edge