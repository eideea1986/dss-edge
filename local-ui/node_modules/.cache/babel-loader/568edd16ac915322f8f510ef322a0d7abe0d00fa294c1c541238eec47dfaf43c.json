{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function Go2RTCPlayer(_ref){let{camId,streamType='hd',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const pcRef=useRef(null);const[status,setStatus]=useState(\"init\");// Fallback State: If 'low' fails, switch to 'hd'\nconst[activeStreamType,setActiveStreamType]=useState(streamType);const[useMjpeg,setUseMjpeg]=useState(false);// Reset fallback if the requested streamType changes from props\nuseEffect(()=>{setActiveStreamType(streamType);setUseMjpeg(false);},[streamType]);// Unified stream name logic for both WebRTC and MJPEG\nconst suffix=activeStreamType==='low'?'sub':activeStreamType;const streamName=\"\".concat(camId,\"_\").concat(suffix);useEffect(()=>{if(useMjpeg)return;const connectWebRTC=async()=>{setStatus(\"connecting\");if(pcRef.current)pcRef.current.close();const pc=new RTCPeerConnection({iceServers:[{urls:\"stun:stun.l.google.com:19302\"}]});pcRef.current=pc;pc.ontrack=event=>{if(videoRef.current){videoRef.current.srcObject=event.streams[0];// play() returns promise, handle rejection\nvideoRef.current.play().catch(e=>{console.warn(\"Autoplay failed\",e);});setStatus(\"playing\");}};pc.addTransceiver('video',{direction:'recvonly'});try{const offer=await pc.createOffer();await pc.setLocalDescription(offer);const apiUrl=\"/rtc/api/webrtc?src=\".concat(streamName);const res=await fetch(apiUrl,{method:'POST',body:pc.localDescription.sdp});if(!res.ok)throw new Error(\"Go2RTC Error: \".concat(res.status));const answerSdp=await res.text();if(pcRef.current&&pcRef.current.signalingState!=='closed'){await pc.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:answerSdp}));}}catch(e){console.warn(\"[Go2RTC] Failed to connect \".concat(streamName,\":\"),e);// Fallback Logic\nif(activeStreamType==='low'||activeStreamType==='sub'){// Covers both\nconsole.log(\"[Go2RTC] Substream failed, trying Main...\");setActiveStreamType('hd');}else if(!useMjpeg){// If both failed, fallback to MJPEG\nconsole.log(\"[Go2RTC] WebRTC failed completely, switching to MJPEG.\");setUseMjpeg(true);}}};if(camId)connectWebRTC();return()=>{if(pcRef.current){pcRef.current.close();pcRef.current=null;}};},[camId,activeStreamType,useMjpeg,streamName]);return/*#__PURE__*/_jsxs(\"div\",{className:\"rtc-player\",style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\",overflow:\"hidden\",width:\"100%\",height:\"100%\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:0,left:0,right:0,bottom:0},children:useMjpeg?/*#__PURE__*/_jsx(\"img\",{className:\"rtc-player-el\",src:\"/rtc/api/stream.mjpeg?src=\".concat(streamName),style:{width:\"100%\",height:\"100%\",objectFit:\"fill\",display:\"block\"},alt:\"Live Stream\"}):/*#__PURE__*/_jsx(\"video\",{className:\"rtc-player-el\",ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\",display:\"block\"},playsInline:true,muted:true,autoPlay:true})}),status!=='playing'&&status!=='init'&&!useMjpeg&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:0,left:0,width:\"100%\",height:\"100%\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",color:\"rgba(255,255,255,0.5)\",fontSize:12,pointerEvents:\"none\",zIndex:2},children:status==='connecting'?'Connecting...':''})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","Go2RTCPlayer","_ref","camId","streamType","style","onClick","onDoubleClick","isHidden","videoRef","pcRef","status","setStatus","activeStreamType","setActiveStreamType","useMjpeg","setUseMjpeg","suffix","streamName","concat","connectWebRTC","current","close","pc","RTCPeerConnection","iceServers","urls","ontrack","event","srcObject","streams","play","catch","e","console","warn","addTransceiver","direction","offer","createOffer","setLocalDescription","apiUrl","res","fetch","method","body","localDescription","sdp","ok","Error","answerSdp","text","signalingState","setRemoteDescription","RTCSessionDescription","type","log","className","_objectSpread","position","background","overflow","width","height","children","top","left","right","bottom","src","objectFit","display","alt","ref","playsInline","muted","autoPlay","alignItems","justifyContent","color","fontSize","pointerEvents","zIndex"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\nexport default function Go2RTCPlayer({ camId, streamType = 'hd', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const pcRef = useRef(null);\r\n    const [status, setStatus] = useState(\"init\");\r\n\r\n    // Fallback State: If 'low' fails, switch to 'hd'\r\n    const [activeStreamType, setActiveStreamType] = useState(streamType);\r\n    const [useMjpeg, setUseMjpeg] = useState(false);\r\n\r\n    // Reset fallback if the requested streamType changes from props\r\n    useEffect(() => {\r\n        setActiveStreamType(streamType);\r\n        setUseMjpeg(false);\r\n    }, [streamType]);\r\n\r\n    // Unified stream name logic for both WebRTC and MJPEG\r\n    const suffix = activeStreamType === 'low' ? 'sub' : activeStreamType;\r\n    const streamName = `${camId}_${suffix}`;\r\n\r\n    useEffect(() => {\r\n        if (useMjpeg) return;\r\n\r\n        const connectWebRTC = async () => {\r\n            setStatus(\"connecting\");\r\n            if (pcRef.current) pcRef.current.close();\r\n\r\n            const pc = new RTCPeerConnection({\r\n                iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n            });\r\n            pcRef.current = pc;\r\n\r\n            pc.ontrack = (event) => {\r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = event.streams[0];\r\n                    // play() returns promise, handle rejection\r\n                    videoRef.current.play().catch(e => {\r\n                        console.warn(\"Autoplay failed\", e);\r\n                    });\r\n                    setStatus(\"playing\");\r\n                }\r\n            };\r\n\r\n            pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n            try {\r\n                const offer = await pc.createOffer();\r\n                await pc.setLocalDescription(offer);\r\n\r\n                const apiUrl = `/rtc/api/webrtc?src=${streamName}`;\r\n                const res = await fetch(apiUrl, { method: 'POST', body: pc.localDescription.sdp });\r\n\r\n                if (!res.ok) throw new Error(`Go2RTC Error: ${res.status}`);\r\n\r\n                const answerSdp = await res.text();\r\n                if (pcRef.current && pcRef.current.signalingState !== 'closed') {\r\n                    await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answerSdp }));\r\n                }\r\n            } catch (e) {\r\n                console.warn(`[Go2RTC] Failed to connect ${streamName}:`, e);\r\n                // Fallback Logic\r\n                if (activeStreamType === 'low' || activeStreamType === 'sub') { // Covers both\r\n                    console.log(`[Go2RTC] Substream failed, trying Main...`);\r\n                    setActiveStreamType('hd');\r\n                } else if (!useMjpeg) {\r\n                    // If both failed, fallback to MJPEG\r\n                    console.log(`[Go2RTC] WebRTC failed completely, switching to MJPEG.`);\r\n                    setUseMjpeg(true);\r\n                }\r\n            }\r\n        };\r\n\r\n        if (camId) connectWebRTC();\r\n\r\n        return () => {\r\n            if (pcRef.current) { pcRef.current.close(); pcRef.current = null; }\r\n        };\r\n    }, [camId, activeStreamType, useMjpeg, streamName]);\r\n\r\n    return (\r\n        <div className=\"rtc-player\" style={{ ...style, position: \"relative\", background: \"#000\", overflow: \"hidden\", width: \"100%\", height: \"100%\" }}\r\n            onClick={onClick}\r\n            onDoubleClick={onDoubleClick}\r\n        >\r\n            <div style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}>\r\n                {useMjpeg ? (\r\n                    <img\r\n                        className=\"rtc-player-el\"\r\n                        src={`/rtc/api/stream.mjpeg?src=${streamName}`}\r\n                        style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\", display: \"block\" }}\r\n                        alt=\"Live Stream\"\r\n                    />\r\n                ) : (\r\n                    <video\r\n                        className=\"rtc-player-el\"\r\n                        ref={videoRef}\r\n                        style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\", display: \"block\" }}\r\n                        playsInline\r\n                        muted\r\n                        autoPlay\r\n                    />\r\n                )}\r\n            </div>\r\n\r\n            {status !== 'playing' && status !== 'init' && !useMjpeg && (\r\n                <div style={{\r\n                    position: \"absolute\", top: 0, left: 0, width: \"100%\", height: \"100%\",\r\n                    display: \"flex\", alignItems: \"center\", justifyContent: \"center\",\r\n                    color: \"rgba(255,255,255,0.5)\", fontSize: 12, pointerEvents: \"none\",\r\n                    zIndex: 2\r\n                }}>\r\n                    {status === 'connecting' ? 'Connecting...' : ''}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}