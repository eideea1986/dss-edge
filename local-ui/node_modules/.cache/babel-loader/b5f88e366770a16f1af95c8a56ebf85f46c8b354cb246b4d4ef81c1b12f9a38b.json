{"ast":null,"code":"import React,{useEffect,useRef}from\"react\";/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */import{jsx as _jsx}from\"react/jsx-runtime\";const streamPool=new Map();/**\r\n * CONFIG FIX (NU hostname din browser)\r\n */const GO2RTC_WEBRTC=\"http://192.168.120.208:8555\";async function acquireStream(camId){let type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"sub\";const key=\"\".concat(camId,\"_\").concat(type);if(streamPool.has(key)){const entry=streamPool.get(key);entry.refs++;return entry;}const pc=new RTCPeerConnection({iceServers:[]});const media=new MediaStream();pc.ontrack=e=>media.addTrack(e.track);pc.addTransceiver(\"video\",{direction:\"recvonly\"});const offer=await pc.createOffer();await pc.setLocalDescription(offer);const res=await fetch(\"\".concat(GO2RTC_WEBRTC,\"/api/webrtc?src=\").concat(key),{method:\"POST\",headers:{\"Content-Type\":\"application/sdp\"},body:offer.sdp});if(!res.ok){throw new Error(\"WebRTC failed \".concat(res.status));}const answer=await res.text();await pc.setRemoteDescription({type:\"answer\",sdp:answer});const entry={pc,media,refs:1};streamPool.set(key,entry);return entry;}function releaseStream(camId){let type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"sub\";const key=\"\".concat(camId,\"_\").concat(type);const entry=streamPool.get(key);if(!entry)return;entry.refs--;// enterprise grace period\nif(entry.refs<=0){setTimeout(()=>{if(entry.refs<=0){entry.pc.close();streamPool.delete(key);}},15000);}}/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */export default function Go2RTCPlayer(_ref){let{camId,streamType=\"sub\"}=_ref;const videoRef=useRef(null);useEffect(()=>{let active=true;let entry;acquireStream(camId,streamType).then(e=>{if(!active)return;entry=e;if(videoRef.current){videoRef.current.srcObject=e.media;}}).catch(console.error);return()=>{active=false;releaseStream(camId,streamType);};},[camId,streamType]);return/*#__PURE__*/_jsx(\"video\",{ref:videoRef,autoPlay:true,muted:true,playsInline:true,style:{width:\"100%\",height:\"100%\",objectFit:\"cover\"}});}","map":{"version":3,"names":["React","useEffect","useRef","jsx","_jsx","streamPool","Map","GO2RTC_WEBRTC","acquireStream","camId","type","arguments","length","undefined","key","concat","has","entry","get","refs","pc","RTCPeerConnection","iceServers","media","MediaStream","ontrack","e","addTrack","track","addTransceiver","direction","offer","createOffer","setLocalDescription","res","fetch","method","headers","body","sdp","ok","Error","status","answer","text","setRemoteDescription","set","releaseStream","setTimeout","close","delete","Go2RTCPlayer","_ref","streamType","videoRef","active","then","current","srcObject","catch","console","error","ref","autoPlay","muted","playsInline","style","width","height","objectFit"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef } from \"react\";\r\n\r\n/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */\r\nconst streamPool = new Map();\r\n\r\n/**\r\n * CONFIG FIX (NU hostname din browser)\r\n */\r\nconst GO2RTC_WEBRTC = \"http://192.168.120.208:8555\";\r\n\r\nasync function acquireStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n\r\n    if (streamPool.has(key)) {\r\n        const entry = streamPool.get(key);\r\n        entry.refs++;\r\n        return entry;\r\n    }\r\n\r\n    const pc = new RTCPeerConnection({ iceServers: [] });\r\n    const media = new MediaStream();\r\n\r\n    pc.ontrack = (e) => media.addTrack(e.track);\r\n    pc.addTransceiver(\"video\", { direction: \"recvonly\" });\r\n\r\n    const offer = await pc.createOffer();\r\n    await pc.setLocalDescription(offer);\r\n\r\n    const res = await fetch(\r\n        `${GO2RTC_WEBRTC}/api/webrtc?src=${key}`,\r\n        {\r\n            method: \"POST\",\r\n            headers: { \"Content-Type\": \"application/sdp\" },\r\n            body: offer.sdp\r\n        }\r\n    );\r\n\r\n    if (!res.ok) {\r\n        throw new Error(`WebRTC failed ${res.status}`);\r\n    }\r\n\r\n    const answer = await res.text();\r\n    await pc.setRemoteDescription({ type: \"answer\", sdp: answer });\r\n\r\n    const entry = {\r\n        pc,\r\n        media,\r\n        refs: 1\r\n    };\r\n\r\n    streamPool.set(key, entry);\r\n    return entry;\r\n}\r\n\r\nfunction releaseStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n    const entry = streamPool.get(key);\r\n    if (!entry) return;\r\n\r\n    entry.refs--;\r\n\r\n    // enterprise grace period\r\n    if (entry.refs <= 0) {\r\n        setTimeout(() => {\r\n            if (entry.refs <= 0) {\r\n                entry.pc.close();\r\n                streamPool.delete(key);\r\n            }\r\n        }, 15000);\r\n    }\r\n}\r\n\r\n/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */\r\nexport default function Go2RTCPlayer({ camId, streamType = \"sub\" }) {\r\n    const videoRef = useRef(null);\r\n\r\n    useEffect(() => {\r\n        let active = true;\r\n        let entry;\r\n\r\n        acquireStream(camId, streamType)\r\n            .then((e) => {\r\n                if (!active) return;\r\n                entry = e;\r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = e.media;\r\n                }\r\n            })\r\n            .catch(console.error);\r\n\r\n        return () => {\r\n            active = false;\r\n            releaseStream(camId, streamType);\r\n        };\r\n    }, [camId, streamType]);\r\n\r\n    return (\r\n        <video\r\n            ref={videoRef}\r\n            autoPlay\r\n            muted\r\n            playsInline\r\n            style={{\r\n                width: \"100%\",\r\n                height: \"100%\",\r\n                objectFit: \"cover\"\r\n            }}\r\n        />\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}