{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function Go2RTCPlayer(_ref){let{camId,streamType='hd',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const pcRef=useRef(null);const[status,setStatus]=useState(\"init\");const[activeStreamType,setActiveStreamType]=useState(streamType);useEffect(()=>{setActiveStreamType(streamType);},[streamType]);const suffix=activeStreamType==='low'?'sub':activeStreamType==='hd'?'hd':'sub';// Fallback to substream for \"live\"\nconst streamName=\"\".concat(camId,\"_\").concat(suffix);const connectWebRTC=async()=>{setStatus(\"connecting\");if(pcRef.current)pcRef.current.close();const pc=new RTCPeerConnection({iceServers:[]// Disable STUN to force local LAN connection\n});pcRef.current=pc;pc.oniceconnectionstatechange=()=>{if(pc.iceConnectionState==='disconnected'||pc.iceConnectionState==='failed'){console.warn(\"[WebRTC] ICE \".concat(pc.iceConnectionState,\", reconnecting...\"));setTimeout(connectWebRTC,1000);}};pc.ontrack=event=>{if(videoRef.current){videoRef.current.srcObject=event.streams[0];videoRef.current.play().catch(()=>{});setStatus(\"playing\");}};pc.addTransceiver('video',{direction:'recvonly'});try{const offer=await pc.createOffer();await pc.setLocalDescription(offer);// We use the local proxy /rtc which points to localhost:8085\nconst apiUrl=\"/rtc/api/webrtc?src=\".concat(streamName);const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/sdp'},body:pc.localDescription.sdp});if(!res.ok)throw new Error(\"Status \".concat(res.status));const answerSdp=await res.text();if(pcRef.current&&pcRef.current.signalingState!=='closed'){await pc.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:answerSdp}));}}catch(e){console.warn(\"[WebRTC] Failed \".concat(streamName,\":\"),e.message);if(status!=='playing')setTimeout(connectWebRTC,2000);}};useEffect(()=>{if(isHidden)return;connectWebRTC();const watchdog=setInterval(()=>{if(videoRef.current&&status==='playing'){const ct=videoRef.current.currentTime;if(ct===(videoRef.current._lastTime||0)){videoRef.current._staleFrames=(videoRef.current._staleFrames||0)+1;if(videoRef.current._staleFrames>4){// 4s freeze\nconsole.warn(\"[WebRTC] Stream frozen, restarting...\");connectWebRTC();videoRef.current._staleFrames=0;}}else{videoRef.current._lastTime=ct;videoRef.current._staleFrames=0;}}},1000);return()=>{clearInterval(watchdog);if(pcRef.current){pcRef.current.close();pcRef.current=null;}};},[camId,activeStreamType,streamName,isHidden]);return/*#__PURE__*/_jsxs(\"div\",{className:\"rtc-player\",style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\",width:\"100%\",height:\"100%\",overflow:\"hidden\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:0,left:0,right:0,bottom:0},children:/*#__PURE__*/_jsx(\"video\",{className:\"rtc-player-el\",ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\",display:\"block\"},playsInline:true,muted:true,autoPlay:true})}),status==='connecting'&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:0,left:0,width:\"100%\",height:\"100%\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",color:\"rgba(255,255,255,0.4)\",fontSize:10,zIndex:2},children:\"Connecting...\"})]});}export default/*#__PURE__*/React.memo(Go2RTCPlayer);","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","Go2RTCPlayer","_ref","camId","streamType","style","onClick","onDoubleClick","isHidden","videoRef","pcRef","status","setStatus","activeStreamType","setActiveStreamType","suffix","streamName","concat","connectWebRTC","current","close","pc","RTCPeerConnection","iceServers","oniceconnectionstatechange","iceConnectionState","console","warn","setTimeout","ontrack","event","srcObject","streams","play","catch","addTransceiver","direction","offer","createOffer","setLocalDescription","apiUrl","res","fetch","method","headers","body","localDescription","sdp","ok","Error","answerSdp","text","signalingState","setRemoteDescription","RTCSessionDescription","type","e","message","watchdog","setInterval","ct","currentTime","_lastTime","_staleFrames","clearInterval","className","_objectSpread","position","background","width","height","overflow","children","top","left","right","bottom","ref","objectFit","display","playsInline","muted","autoPlay","alignItems","justifyContent","color","fontSize","zIndex","memo"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\nfunction Go2RTCPlayer({ camId, streamType = 'hd', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const pcRef = useRef(null);\r\n    const [status, setStatus] = useState(\"init\");\r\n    const [activeStreamType, setActiveStreamType] = useState(streamType);\r\n\r\n    useEffect(() => {\r\n        setActiveStreamType(streamType);\r\n    }, [streamType]);\r\n\r\n    const suffix =\r\n        activeStreamType === 'low' ? 'sub' :\r\n            activeStreamType === 'hd' ? 'hd' :\r\n                'sub'; // Fallback to substream for \"live\"\r\n\r\n    const streamName = `${camId}_${suffix}`;\r\n\r\n    const connectWebRTC = async () => {\r\n        setStatus(\"connecting\");\r\n        if (pcRef.current) pcRef.current.close();\r\n\r\n        const pc = new RTCPeerConnection({\r\n            iceServers: [] // Disable STUN to force local LAN connection\r\n        });\r\n        pcRef.current = pc;\r\n\r\n        pc.oniceconnectionstatechange = () => {\r\n            if (pc.iceConnectionState === 'disconnected' || pc.iceConnectionState === 'failed') {\r\n                console.warn(`[WebRTC] ICE ${pc.iceConnectionState}, reconnecting...`);\r\n                setTimeout(connectWebRTC, 1000);\r\n            }\r\n        };\r\n\r\n        pc.ontrack = (event) => {\r\n            if (videoRef.current) {\r\n                videoRef.current.srcObject = event.streams[0];\r\n                videoRef.current.play().catch(() => { });\r\n                setStatus(\"playing\");\r\n            }\r\n        };\r\n\r\n        pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n        try {\r\n            const offer = await pc.createOffer();\r\n            await pc.setLocalDescription(offer);\r\n\r\n            // We use the local proxy /rtc which points to localhost:8085\r\n            const apiUrl = `/rtc/api/webrtc?src=${streamName}`;\r\n\r\n            const res = await fetch(apiUrl, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/sdp' },\r\n                body: pc.localDescription.sdp\r\n            });\r\n\r\n            if (!res.ok) throw new Error(`Status ${res.status}`);\r\n\r\n            const answerSdp = await res.text();\r\n            if (pcRef.current && pcRef.current.signalingState !== 'closed') {\r\n                await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answerSdp }));\r\n            }\r\n        } catch (e) {\r\n            console.warn(`[WebRTC] Failed ${streamName}:`, e.message);\r\n            if (status !== 'playing') setTimeout(connectWebRTC, 2000);\r\n        }\r\n    };\r\n\r\n    useEffect(() => {\r\n        if (isHidden) return;\r\n        connectWebRTC();\r\n\r\n        const watchdog = setInterval(() => {\r\n            if (videoRef.current && status === 'playing') {\r\n                const ct = videoRef.current.currentTime;\r\n                if (ct === (videoRef.current._lastTime || 0)) {\r\n                    videoRef.current._staleFrames = (videoRef.current._staleFrames || 0) + 1;\r\n                    if (videoRef.current._staleFrames > 4) { // 4s freeze\r\n                        console.warn(\"[WebRTC] Stream frozen, restarting...\");\r\n                        connectWebRTC();\r\n                        videoRef.current._staleFrames = 0;\r\n                    }\r\n                } else {\r\n                    videoRef.current._lastTime = ct;\r\n                    videoRef.current._staleFrames = 0;\r\n                }\r\n            }\r\n        }, 1000);\r\n\r\n        return () => {\r\n            clearInterval(watchdog);\r\n            if (pcRef.current) { pcRef.current.close(); pcRef.current = null; }\r\n        };\r\n    }, [camId, activeStreamType, streamName, isHidden]);\r\n\r\n    return (\r\n        <div className=\"rtc-player\" style={{ ...style, position: \"relative\", background: \"#000\", width: \"100%\", height: \"100%\", overflow: \"hidden\" }}\r\n            onClick={onClick} onDoubleClick={onDoubleClick}>\r\n            <div style={{ position: \"absolute\", top: 0, left: 0, right: 0, bottom: 0 }}>\r\n                <video\r\n                    className=\"rtc-player-el\"\r\n                    ref={videoRef}\r\n                    style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\", display: \"block\" }}\r\n                    playsInline muted autoPlay\r\n                />\r\n            </div>\r\n            {status === 'connecting' && (\r\n                <div style={{ position: \"absolute\", top: 0, left: 0, width: \"100%\", height: \"100%\", display: \"flex\", alignItems: \"center\", justifyContent: \"center\", color: \"rgba(255,255,255,0.4)\", fontSize: 10, zIndex: 2 }}>\r\n                    Connecting...\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default React.memo(Go2RTCPlayer);\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}