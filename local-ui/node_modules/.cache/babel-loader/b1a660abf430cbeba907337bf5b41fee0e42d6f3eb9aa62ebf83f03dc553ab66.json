{"ast":null,"code":"import Hls from'hls.js';export default class PlaybackCoreV2{constructor(videoElement,camId){let baseUrl=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'/api';this.video=videoElement;this.camId=camId;this.baseUrl=baseUrl;this.hls=null;this.currentFragPDT=0;this.currentFragStartPTS=0;this.windowStartTime=0;this.windowEndTime=0;this.isReloading=false;}setSegments(segments){}start(startEpochMs){// WINDOWED VOD: 1 hour window (optimal for most networks)\nconst WINDOW_MS=60*60*1000;// 1 hour\nthis.windowStartTime=startEpochMs;this.windowEndTime=startEpochMs+WINDOW_MS;const playlistUrl=\"\".concat(this.baseUrl,\"/playback/playlist/\").concat(this.camId,\".m3u8?start=\").concat(this.windowStartTime,\"&end=\").concat(this.windowEndTime);// CRITICAL: Only create HLS instance once, reuse for reloads\nif(!this.hls&&Hls.isSupported()){this.hls=new Hls({debug:false,enableWorker:true,manifestLoadingTimeOut:10000,fragLoadingTimeOut:20000,startFragPrefetch:true,// Buffer settings\nmaxBufferLength:30,maxMaxBufferLength:60,backBufferLength:10});this.hls.attachMedia(this.video);this.hls.on(Hls.Events.MANIFEST_PARSED,()=>{this.video.play().catch(e=>console.warn(\"Autoplay blocked\",e));});this.hls.on(Hls.Events.FRAG_CHANGED,(event,data)=>{if(data.frag&&data.frag.programDateTime){this.currentFragPDT=data.frag.programDateTime;this.currentFragStartPTS=data.frag.start;}});this.hls.on(Hls.Events.ERROR,(event,data)=>{if(data.fatal){console.error(\"[HLS] FATAL: \".concat(data.type),data.details);switch(data.type){case Hls.ErrorTypes.NETWORK_ERROR:this.hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:this.hls.recoverMediaError();break;default:this.hls.destroy();this.hls=null;break;}}});// CRITICAL: Monitor playback position for window reload\nthis.video.addEventListener('timeupdate',()=>{if(this.isReloading)return;const currentEpoch=this.getCurrentEpochMs();if(!currentEpoch||currentEpoch===0)return;// Reload when approaching end of window (5 minutes before)\nconst timeUntilEnd=this.windowEndTime-currentEpoch;if(timeUntilEnd<5*60*1000&&timeUntilEnd>0){this.reloadNextWindow(currentEpoch);}});}// Load source (first time or reload)\nthis.hls.loadSource(playlistUrl);if(!Hls.isSupported()&&this.video.canPlayType('application/vnd.apple.mpegurl')){// Safari native HLS\nthis.video.src=playlistUrl;this.video.addEventListener('loadedmetadata',()=>this.video.play());}}reloadNextWindow(currentEpoch){if(this.isReloading)return;this.isReloading=true;console.log('[PlaybackCore] Reloading next window from',new Date(currentEpoch).toISOString());// CRITICAL: Update window WITHOUT destroying player\nconst WINDOW_MS=60*60*1000;this.windowStartTime=currentEpoch;this.windowEndTime=currentEpoch+WINDOW_MS;const playlistUrl=\"\".concat(this.baseUrl,\"/playback/playlist/\").concat(this.camId,\".m3u8?start=\").concat(this.windowStartTime,\"&end=\").concat(this.windowEndTime);// SEAMLESS RELOAD: Just change source, HLS.js continues playback\nthis.hls.loadSource(playlistUrl);// Allow next reload after 30 seconds\nsetTimeout(()=>{this.isReloading=false;},30000);}seekTo(ts){// For seek, we need to reload with new window\nif(this.hls){this.hls.destroy();this.hls=null;}this.isReloading=false;this.start(ts);}getCurrentEpochMs(){if(this.currentFragPDT&&this.hls){const timeInFrag=this.video.currentTime-this.currentFragStartPTS;const absoluteTime=this.currentFragPDT+timeInFrag*1000;return absoluteTime;}if(this.video.getStartDate&&typeof this.video.getStartDate==='function'){const sd=this.video.getStartDate();if(sd&&!isNaN(sd.getTime())){return sd.getTime()+this.video.currentTime*1000;}}return 0;}destroy(){if(this.hls){this.hls.destroy();this.hls=null;}}}","map":{"version":3,"names":["Hls","PlaybackCoreV2","constructor","videoElement","camId","baseUrl","arguments","length","undefined","video","hls","currentFragPDT","currentFragStartPTS","windowStartTime","windowEndTime","isReloading","setSegments","segments","start","startEpochMs","WINDOW_MS","playlistUrl","concat","isSupported","debug","enableWorker","manifestLoadingTimeOut","fragLoadingTimeOut","startFragPrefetch","maxBufferLength","maxMaxBufferLength","backBufferLength","attachMedia","on","Events","MANIFEST_PARSED","play","catch","e","console","warn","FRAG_CHANGED","event","data","frag","programDateTime","ERROR","fatal","error","type","details","ErrorTypes","NETWORK_ERROR","startLoad","MEDIA_ERROR","recoverMediaError","destroy","addEventListener","currentEpoch","getCurrentEpochMs","timeUntilEnd","reloadNextWindow","loadSource","canPlayType","src","log","Date","toISOString","setTimeout","seekTo","ts","timeInFrag","currentTime","absoluteTime","getStartDate","sd","isNaN","getTime"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/services/PlaybackCoreV2.js"],"sourcesContent":["import Hls from 'hls.js';\r\n\r\nexport default class PlaybackCoreV2 {\r\n    constructor(videoElement, camId, baseUrl = '/api') {\r\n        this.video = videoElement;\r\n        this.camId = camId;\r\n        this.baseUrl = baseUrl;\r\n        this.hls = null;\r\n        this.currentFragPDT = 0;\r\n        this.currentFragStartPTS = 0;\r\n        this.windowStartTime = 0;\r\n        this.windowEndTime = 0;\r\n        this.isReloading = false;\r\n    }\r\n\r\n    setSegments(segments) { }\r\n\r\n    start(startEpochMs) {\r\n        // WINDOWED VOD: 1 hour window (optimal for most networks)\r\n        const WINDOW_MS = 60 * 60 * 1000; // 1 hour\r\n\r\n        this.windowStartTime = startEpochMs;\r\n        this.windowEndTime = startEpochMs + WINDOW_MS;\r\n\r\n        const playlistUrl = `${this.baseUrl}/playback/playlist/${this.camId}.m3u8?start=${this.windowStartTime}&end=${this.windowEndTime}`;\r\n\r\n        // CRITICAL: Only create HLS instance once, reuse for reloads\r\n        if (!this.hls && Hls.isSupported()) {\r\n            this.hls = new Hls({\r\n                debug: false,\r\n                enableWorker: true,\r\n                manifestLoadingTimeOut: 10000,\r\n                fragLoadingTimeOut: 20000,\r\n                startFragPrefetch: true,\r\n\r\n                // Buffer settings\r\n                maxBufferLength: 30,\r\n                maxMaxBufferLength: 60,\r\n                backBufferLength: 10,\r\n            });\r\n\r\n            this.hls.attachMedia(this.video);\r\n\r\n            this.hls.on(Hls.Events.MANIFEST_PARSED, () => {\r\n                this.video.play().catch(e => console.warn(\"Autoplay blocked\", e));\r\n            });\r\n\r\n            this.hls.on(Hls.Events.FRAG_CHANGED, (event, data) => {\r\n                if (data.frag && data.frag.programDateTime) {\r\n                    this.currentFragPDT = data.frag.programDateTime;\r\n                    this.currentFragStartPTS = data.frag.start;\r\n                }\r\n            });\r\n\r\n            this.hls.on(Hls.Events.ERROR, (event, data) => {\r\n                if (data.fatal) {\r\n                    console.error(`[HLS] FATAL: ${data.type}`, data.details);\r\n                    switch (data.type) {\r\n                        case Hls.ErrorTypes.NETWORK_ERROR:\r\n                            this.hls.startLoad();\r\n                            break;\r\n                        case Hls.ErrorTypes.MEDIA_ERROR:\r\n                            this.hls.recoverMediaError();\r\n                            break;\r\n                        default:\r\n                            this.hls.destroy();\r\n                            this.hls = null;\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n            // CRITICAL: Monitor playback position for window reload\r\n            this.video.addEventListener('timeupdate', () => {\r\n                if (this.isReloading) return;\r\n\r\n                const currentEpoch = this.getCurrentEpochMs();\r\n                if (!currentEpoch || currentEpoch === 0) return;\r\n\r\n                // Reload when approaching end of window (5 minutes before)\r\n                const timeUntilEnd = this.windowEndTime - currentEpoch;\r\n                if (timeUntilEnd < 5 * 60 * 1000 && timeUntilEnd > 0) {\r\n                    this.reloadNextWindow(currentEpoch);\r\n                }\r\n            });\r\n        }\r\n\r\n        // Load source (first time or reload)\r\n        this.hls.loadSource(playlistUrl);\r\n\r\n        if (!Hls.isSupported() && this.video.canPlayType('application/vnd.apple.mpegurl')) {\r\n            // Safari native HLS\r\n            this.video.src = playlistUrl;\r\n            this.video.addEventListener('loadedmetadata', () => this.video.play());\r\n        }\r\n    }\r\n\r\n    reloadNextWindow(currentEpoch) {\r\n        if (this.isReloading) return;\r\n        this.isReloading = true;\r\n\r\n        console.log('[PlaybackCore] Reloading next window from', new Date(currentEpoch).toISOString());\r\n\r\n        // CRITICAL: Update window WITHOUT destroying player\r\n        const WINDOW_MS = 60 * 60 * 1000;\r\n        this.windowStartTime = currentEpoch;\r\n        this.windowEndTime = currentEpoch + WINDOW_MS;\r\n\r\n        const playlistUrl = `${this.baseUrl}/playback/playlist/${this.camId}.m3u8?start=${this.windowStartTime}&end=${this.windowEndTime}`;\r\n\r\n        // SEAMLESS RELOAD: Just change source, HLS.js continues playback\r\n        this.hls.loadSource(playlistUrl);\r\n\r\n        // Allow next reload after 30 seconds\r\n        setTimeout(() => {\r\n            this.isReloading = false;\r\n        }, 30000);\r\n    }\r\n\r\n    seekTo(ts) {\r\n        // For seek, we need to reload with new window\r\n        if (this.hls) {\r\n            this.hls.destroy();\r\n            this.hls = null;\r\n        }\r\n        this.isReloading = false;\r\n        this.start(ts);\r\n    }\r\n\r\n    getCurrentEpochMs() {\r\n        if (this.currentFragPDT && this.hls) {\r\n            const timeInFrag = this.video.currentTime - this.currentFragStartPTS;\r\n            const absoluteTime = this.currentFragPDT + (timeInFrag * 1000);\r\n            return absoluteTime;\r\n        }\r\n        if (this.video.getStartDate && typeof this.video.getStartDate === 'function') {\r\n            const sd = this.video.getStartDate();\r\n            if (sd && !isNaN(sd.getTime())) {\r\n                return sd.getTime() + (this.video.currentTime * 1000);\r\n            }\r\n        }\r\n        return 0;\r\n    }\r\n\r\n    destroy() {\r\n        if (this.hls) {\r\n            this.hls.destroy();\r\n            this.hls = null;\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}