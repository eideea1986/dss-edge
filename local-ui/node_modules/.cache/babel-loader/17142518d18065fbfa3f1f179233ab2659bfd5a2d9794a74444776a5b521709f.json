{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';// Global stream manager - persists across component renders\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const globalStreams=new Map();async function getOrCreateStream(camId,streamType){const streamName=\"\".concat(camId,\"_\").concat(streamType);if(globalStreams.has(streamName)){return globalStreams.get(streamName);}// Create new WebRTC connection\nconst pc=new RTCPeerConnection({iceServers:[]});pc.addTransceiver('video',{direction:'recvonly'});const offer=await pc.createOffer();await pc.setLocalDescription(offer);const apiUrl=\"http://\".concat(window.location.hostname,\":8085/api/webrtc?src=\").concat(streamName);const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/sdp'},body:offer.sdp});if(!res.ok)throw new Error(\"Failed: \".concat(res.status));const answer=await res.text();await pc.setRemoteDescription({type:'answer',sdp:answer});// Wait for track\nconst stream=await new Promise(resolve=>{pc.ontrack=e=>resolve(e.streams[0]);});globalStreams.set(streamName,{pc,stream});return{pc,stream};}function Go2RTCPlayer(_ref){let{camId,streamType='sub',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const[error,setError]=useState(null);useEffect(()=>{if(isHidden||!camId)return;let mounted=true;getOrCreateStream(camId,streamType).then(_ref2=>{let{stream}=_ref2;if(mounted&&videoRef.current){videoRef.current.srcObject=stream;videoRef.current.play().catch(()=>{});}}).catch(err=>{if(mounted)setError(err.message);});return()=>{mounted=false;// Do NOT close the stream - it stays alive\n};},[camId,streamType,isHidden]);return/*#__PURE__*/_jsxs(\"div\",{style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[/*#__PURE__*/_jsx(\"video\",{ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\"},playsInline:true,muted:true,autoPlay:true}),error&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:\"50%\",left:\"50%\",transform:\"translate(-50%, -50%)\",color:\"red\",fontSize:10},children:error})]});}export default/*#__PURE__*/React.memo(Go2RTCPlayer);","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","globalStreams","Map","getOrCreateStream","camId","streamType","streamName","concat","has","get","pc","RTCPeerConnection","iceServers","addTransceiver","direction","offer","createOffer","setLocalDescription","apiUrl","window","location","hostname","res","fetch","method","headers","body","sdp","ok","Error","status","answer","text","setRemoteDescription","type","stream","Promise","resolve","ontrack","e","streams","set","Go2RTCPlayer","_ref","style","onClick","onDoubleClick","isHidden","videoRef","error","setError","mounted","then","_ref2","current","srcObject","play","catch","err","message","_objectSpread","position","background","children","ref","width","height","objectFit","playsInline","muted","autoPlay","top","left","transform","color","fontSize","memo"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\n// Global stream manager - persists across component renders\r\nconst globalStreams = new Map();\r\n\r\nasync function getOrCreateStream(camId, streamType) {\r\n    const streamName = `${camId}_${streamType}`;\r\n\r\n    if (globalStreams.has(streamName)) {\r\n        return globalStreams.get(streamName);\r\n    }\r\n\r\n    // Create new WebRTC connection\r\n    const pc = new RTCPeerConnection({ iceServers: [] });\r\n    pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n    const offer = await pc.createOffer();\r\n    await pc.setLocalDescription(offer);\r\n\r\n    const apiUrl = `http://${window.location.hostname}:8085/api/webrtc?src=${streamName}`;\r\n    const res = await fetch(apiUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/sdp' },\r\n        body: offer.sdp\r\n    });\r\n\r\n    if (!res.ok) throw new Error(`Failed: ${res.status}`);\r\n\r\n    const answer = await res.text();\r\n    await pc.setRemoteDescription({ type: 'answer', sdp: answer });\r\n\r\n    // Wait for track\r\n    const stream = await new Promise((resolve) => {\r\n        pc.ontrack = (e) => resolve(e.streams[0]);\r\n    });\r\n\r\n    globalStreams.set(streamName, { pc, stream });\r\n    return { pc, stream };\r\n}\r\n\r\nfunction Go2RTCPlayer({ camId, streamType = 'sub', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const [error, setError] = useState(null);\r\n\r\n    useEffect(() => {\r\n        if (isHidden || !camId) return;\r\n\r\n        let mounted = true;\r\n\r\n        getOrCreateStream(camId, streamType)\r\n            .then(({ stream }) => {\r\n                if (mounted && videoRef.current) {\r\n                    videoRef.current.srcObject = stream;\r\n                    videoRef.current.play().catch(() => { });\r\n                }\r\n            })\r\n            .catch(err => {\r\n                if (mounted) setError(err.message);\r\n            });\r\n\r\n        return () => {\r\n            mounted = false;\r\n            // Do NOT close the stream - it stays alive\r\n        };\r\n    }, [camId, streamType, isHidden]);\r\n\r\n    return (\r\n        <div style={{ ...style, position: \"relative\", background: \"#000\" }}\r\n            onClick={onClick} onDoubleClick={onDoubleClick}>\r\n            <video\r\n                ref={videoRef}\r\n                style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\" }}\r\n                playsInline muted autoPlay\r\n            />\r\n            {error && (\r\n                <div style={{ position: \"absolute\", top: \"50%\", left: \"50%\", transform: \"translate(-50%, -50%)\", color: \"red\", fontSize: 10 }}>\r\n                    {error}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default React.memo(Go2RTCPlayer);\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}