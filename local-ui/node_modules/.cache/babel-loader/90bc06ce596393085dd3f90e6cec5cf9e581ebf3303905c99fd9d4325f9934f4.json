{"ast":null,"code":"var _jsxFileName = \"I:\\\\dispecerat\\\\github_release\\\\dss-edge\\\\local-ui\\\\src\\\\components\\\\Go2RTCPlayer.js\",\n  _s = $RefreshSig$();\nimport React, { useEffect, useRef } from \"react\";\n\n/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst streamPool = new Map();\n\n/**\r\n * CONFIG FIX: Use the unified /rtc proxy on the main API port\r\n */\nconst GO2RTC_API = `${window.location.origin}/rtc`;\nasync function acquireStream(camId, type = \"sub\") {\n  const key = `${camId}_${type}`;\n  if (streamPool.has(key)) {\n    const entry = streamPool.get(key);\n    entry.refs++;\n    console.log(`[Go2RTCPlayer] Reusing stream for ${key}, refs: ${entry.refs}`);\n    return entry;\n  }\n  console.log(`[Go2RTCPlayer] Creating new WebRTC connection for ${key}`);\n  const pc = new RTCPeerConnection({\n    iceServers: []\n  });\n  const media = new MediaStream();\n  pc.ontrack = e => {\n    console.log(`[Go2RTCPlayer] Track received for ${key}`);\n    media.addTrack(e.track);\n  };\n  pc.addTransceiver(\"video\", {\n    direction: \"recvonly\"\n  });\n  try {\n    const offer = await pc.createOffer();\n    await pc.setLocalDescription(offer);\n    const res = await fetch(`${GO2RTC_API}/api/webrtc?src=${key}`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/sdp\"\n      },\n      body: offer.sdp\n    });\n    if (!res.ok) {\n      throw new Error(`WebRTC signaling failed: ${res.status}`);\n    }\n    const answer = await res.text();\n    await pc.setRemoteDescription({\n      type: \"answer\",\n      sdp: answer\n    });\n    const entry = {\n      pc,\n      media,\n      refs: 1\n    };\n    streamPool.set(key, entry);\n    return entry;\n  } catch (err) {\n    pc.close();\n    throw err;\n  }\n}\nfunction releaseStream(camId, type = \"sub\") {\n  const key = `${camId}_${type}`;\n  const entry = streamPool.get(key);\n  if (!entry) return;\n  entry.refs--;\n  console.log(`[Go2RTCPlayer] Released stream for ${key}, refs: ${entry.refs}`);\n\n  // 15s grace period to prevent flickering during tab switches\n  if (entry.refs <= 0) {\n    setTimeout(() => {\n      const currentEntry = streamPool.get(key);\n      if (currentEntry && currentEntry.refs <= 0) {\n        console.log(`[Go2RTCPlayer] Closing idle connection for ${key}`);\n        currentEntry.pc.close();\n        streamPool.delete(key);\n      }\n    }, 15000);\n  }\n}\n\n/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */\nexport default function Go2RTCPlayer({\n  camId,\n  streamType = \"sub\",\n  style,\n  isHidden\n}) {\n  _s();\n  const videoRef = useRef(null);\n  const type = streamType === 'low' || streamType === 'sub' ? 'sub' : 'hd';\n  useEffect(() => {\n    if (isHidden || !camId) return;\n    let active = true;\n    let streamEntry;\n    acquireStream(camId, type).then(entry => {\n      if (!active) {\n        releaseStream(camId, type);\n        return;\n      }\n      streamEntry = entry;\n      if (videoRef.current) {\n        videoRef.current.srcObject = entry.media;\n        videoRef.current.play().catch(() => {});\n      }\n    }).catch(err => {\n      console.error(`[Go2RTCPlayer] Error for ${camId}_${type}:`, err);\n    });\n    return () => {\n      active = false;\n      if (streamEntry) {\n        releaseStream(camId, type);\n      }\n    };\n  }, [camId, type, isHidden]);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    style: {\n      ...style,\n      position: \"relative\",\n      background: \"#000\",\n      width: \"100%\",\n      height: \"100%\"\n    },\n    children: /*#__PURE__*/_jsxDEV(\"video\", {\n      ref: videoRef,\n      autoPlay: true,\n      muted: true,\n      playsInline: true,\n      style: {\n        width: \"100%\",\n        height: \"100%\",\n        objectFit: \"fill\"\n      }\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 128,\n      columnNumber: 13\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 127,\n    columnNumber: 9\n  }, this);\n}\n_s(Go2RTCPlayer, \"PdMsmLAy5JKU3vCrhAlqGYQfKuA=\");\n_c = Go2RTCPlayer;\nvar _c;\n$RefreshReg$(_c, \"Go2RTCPlayer\");","map":{"version":3,"names":["React","useEffect","useRef","jsxDEV","_jsxDEV","streamPool","Map","GO2RTC_API","window","location","origin","acquireStream","camId","type","key","has","entry","get","refs","console","log","pc","RTCPeerConnection","iceServers","media","MediaStream","ontrack","e","addTrack","track","addTransceiver","direction","offer","createOffer","setLocalDescription","res","fetch","method","headers","body","sdp","ok","Error","status","answer","text","setRemoteDescription","set","err","close","releaseStream","setTimeout","currentEntry","delete","Go2RTCPlayer","streamType","style","isHidden","_s","videoRef","active","streamEntry","then","current","srcObject","play","catch","error","position","background","width","height","children","ref","autoPlay","muted","playsInline","objectFit","fileName","_jsxFileName","lineNumber","columnNumber","_c","$RefreshReg$"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef } from \"react\";\r\n\r\n/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */\r\nconst streamPool = new Map();\r\n\r\n/**\r\n * CONFIG FIX: Use the unified /rtc proxy on the main API port\r\n */\r\nconst GO2RTC_API = `${window.location.origin}/rtc`;\r\n\r\nasync function acquireStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n\r\n    if (streamPool.has(key)) {\r\n        const entry = streamPool.get(key);\r\n        entry.refs++;\r\n        console.log(`[Go2RTCPlayer] Reusing stream for ${key}, refs: ${entry.refs}`);\r\n        return entry;\r\n    }\r\n\r\n    console.log(`[Go2RTCPlayer] Creating new WebRTC connection for ${key}`);\r\n    const pc = new RTCPeerConnection({ iceServers: [] });\r\n    const media = new MediaStream();\r\n\r\n    pc.ontrack = (e) => {\r\n        console.log(`[Go2RTCPlayer] Track received for ${key}`);\r\n        media.addTrack(e.track);\r\n    };\r\n\r\n    pc.addTransceiver(\"video\", { direction: \"recvonly\" });\r\n\r\n    try {\r\n        const offer = await pc.createOffer();\r\n        await pc.setLocalDescription(offer);\r\n\r\n        const res = await fetch(\r\n            `${GO2RTC_API}/api/webrtc?src=${key}`,\r\n            {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/sdp\" },\r\n                body: offer.sdp\r\n            }\r\n        );\r\n\r\n        if (!res.ok) {\r\n            throw new Error(`WebRTC signaling failed: ${res.status}`);\r\n        }\r\n\r\n        const answer = await res.text();\r\n        await pc.setRemoteDescription({ type: \"answer\", sdp: answer });\r\n\r\n        const entry = {\r\n            pc,\r\n            media,\r\n            refs: 1\r\n        };\r\n\r\n        streamPool.set(key, entry);\r\n        return entry;\r\n    } catch (err) {\r\n        pc.close();\r\n        throw err;\r\n    }\r\n}\r\n\r\nfunction releaseStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n    const entry = streamPool.get(key);\r\n    if (!entry) return;\r\n\r\n    entry.refs--;\r\n    console.log(`[Go2RTCPlayer] Released stream for ${key}, refs: ${entry.refs}`);\r\n\r\n    // 15s grace period to prevent flickering during tab switches\r\n    if (entry.refs <= 0) {\r\n        setTimeout(() => {\r\n            const currentEntry = streamPool.get(key);\r\n            if (currentEntry && currentEntry.refs <= 0) {\r\n                console.log(`[Go2RTCPlayer] Closing idle connection for ${key}`);\r\n                currentEntry.pc.close();\r\n                streamPool.delete(key);\r\n            }\r\n        }, 15000);\r\n    }\r\n}\r\n\r\n/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */\r\nexport default function Go2RTCPlayer({ camId, streamType = \"sub\", style, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const type = streamType === 'low' || streamType === 'sub' ? 'sub' : 'hd';\r\n\r\n    useEffect(() => {\r\n        if (isHidden || !camId) return;\r\n\r\n        let active = true;\r\n        let streamEntry;\r\n\r\n        acquireStream(camId, type)\r\n            .then((entry) => {\r\n                if (!active) {\r\n                    releaseStream(camId, type);\r\n                    return;\r\n                }\r\n                streamEntry = entry;\r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = entry.media;\r\n                    videoRef.current.play().catch(() => { });\r\n                }\r\n            })\r\n            .catch((err) => {\r\n                console.error(`[Go2RTCPlayer] Error for ${camId}_${type}:`, err);\r\n            });\r\n\r\n        return () => {\r\n            active = false;\r\n            if (streamEntry) {\r\n                releaseStream(camId, type);\r\n            }\r\n        };\r\n    }, [camId, type, isHidden]);\r\n\r\n    return (\r\n        <div style={{ ...style, position: \"relative\", background: \"#000\", width: \"100%\", height: \"100%\" }}>\r\n            <video\r\n                ref={videoRef}\r\n                autoPlay\r\n                muted\r\n                playsInline\r\n                style={{\r\n                    width: \"100%\",\r\n                    height: \"100%\",\r\n                    objectFit: \"fill\"\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n"],"mappings":";;AAAA,OAAOA,KAAK,IAAIC,SAAS,EAAEC,MAAM,QAAQ,OAAO;;AAEhD;AACA;AACA;AAFA,SAAAC,MAAA,IAAAC,OAAA;AAGA,MAAMC,UAAU,GAAG,IAAIC,GAAG,CAAC,CAAC;;AAE5B;AACA;AACA;AACA,MAAMC,UAAU,GAAG,GAAGC,MAAM,CAACC,QAAQ,CAACC,MAAM,MAAM;AAElD,eAAeC,aAAaA,CAACC,KAAK,EAAEC,IAAI,GAAG,KAAK,EAAE;EAC9C,MAAMC,GAAG,GAAG,GAAGF,KAAK,IAAIC,IAAI,EAAE;EAE9B,IAAIR,UAAU,CAACU,GAAG,CAACD,GAAG,CAAC,EAAE;IACrB,MAAME,KAAK,GAAGX,UAAU,CAACY,GAAG,CAACH,GAAG,CAAC;IACjCE,KAAK,CAACE,IAAI,EAAE;IACZC,OAAO,CAACC,GAAG,CAAC,qCAAqCN,GAAG,WAAWE,KAAK,CAACE,IAAI,EAAE,CAAC;IAC5E,OAAOF,KAAK;EAChB;EAEAG,OAAO,CAACC,GAAG,CAAC,qDAAqDN,GAAG,EAAE,CAAC;EACvE,MAAMO,EAAE,GAAG,IAAIC,iBAAiB,CAAC;IAAEC,UAAU,EAAE;EAAG,CAAC,CAAC;EACpD,MAAMC,KAAK,GAAG,IAAIC,WAAW,CAAC,CAAC;EAE/BJ,EAAE,CAACK,OAAO,GAAIC,CAAC,IAAK;IAChBR,OAAO,CAACC,GAAG,CAAC,qCAAqCN,GAAG,EAAE,CAAC;IACvDU,KAAK,CAACI,QAAQ,CAACD,CAAC,CAACE,KAAK,CAAC;EAC3B,CAAC;EAEDR,EAAE,CAACS,cAAc,CAAC,OAAO,EAAE;IAAEC,SAAS,EAAE;EAAW,CAAC,CAAC;EAErD,IAAI;IACA,MAAMC,KAAK,GAAG,MAAMX,EAAE,CAACY,WAAW,CAAC,CAAC;IACpC,MAAMZ,EAAE,CAACa,mBAAmB,CAACF,KAAK,CAAC;IAEnC,MAAMG,GAAG,GAAG,MAAMC,KAAK,CACnB,GAAG7B,UAAU,mBAAmBO,GAAG,EAAE,EACrC;MACIuB,MAAM,EAAE,MAAM;MACdC,OAAO,EAAE;QAAE,cAAc,EAAE;MAAkB,CAAC;MAC9CC,IAAI,EAAEP,KAAK,CAACQ;IAChB,CACJ,CAAC;IAED,IAAI,CAACL,GAAG,CAACM,EAAE,EAAE;MACT,MAAM,IAAIC,KAAK,CAAC,4BAA4BP,GAAG,CAACQ,MAAM,EAAE,CAAC;IAC7D;IAEA,MAAMC,MAAM,GAAG,MAAMT,GAAG,CAACU,IAAI,CAAC,CAAC;IAC/B,MAAMxB,EAAE,CAACyB,oBAAoB,CAAC;MAAEjC,IAAI,EAAE,QAAQ;MAAE2B,GAAG,EAAEI;IAAO,CAAC,CAAC;IAE9D,MAAM5B,KAAK,GAAG;MACVK,EAAE;MACFG,KAAK;MACLN,IAAI,EAAE;IACV,CAAC;IAEDb,UAAU,CAAC0C,GAAG,CAACjC,GAAG,EAAEE,KAAK,CAAC;IAC1B,OAAOA,KAAK;EAChB,CAAC,CAAC,OAAOgC,GAAG,EAAE;IACV3B,EAAE,CAAC4B,KAAK,CAAC,CAAC;IACV,MAAMD,GAAG;EACb;AACJ;AAEA,SAASE,aAAaA,CAACtC,KAAK,EAAEC,IAAI,GAAG,KAAK,EAAE;EACxC,MAAMC,GAAG,GAAG,GAAGF,KAAK,IAAIC,IAAI,EAAE;EAC9B,MAAMG,KAAK,GAAGX,UAAU,CAACY,GAAG,CAACH,GAAG,CAAC;EACjC,IAAI,CAACE,KAAK,EAAE;EAEZA,KAAK,CAACE,IAAI,EAAE;EACZC,OAAO,CAACC,GAAG,CAAC,sCAAsCN,GAAG,WAAWE,KAAK,CAACE,IAAI,EAAE,CAAC;;EAE7E;EACA,IAAIF,KAAK,CAACE,IAAI,IAAI,CAAC,EAAE;IACjBiC,UAAU,CAAC,MAAM;MACb,MAAMC,YAAY,GAAG/C,UAAU,CAACY,GAAG,CAACH,GAAG,CAAC;MACxC,IAAIsC,YAAY,IAAIA,YAAY,CAAClC,IAAI,IAAI,CAAC,EAAE;QACxCC,OAAO,CAACC,GAAG,CAAC,8CAA8CN,GAAG,EAAE,CAAC;QAChEsC,YAAY,CAAC/B,EAAE,CAAC4B,KAAK,CAAC,CAAC;QACvB5C,UAAU,CAACgD,MAAM,CAACvC,GAAG,CAAC;MAC1B;IACJ,CAAC,EAAE,KAAK,CAAC;EACb;AACJ;;AAEA;AACA;AACA;AACA,eAAe,SAASwC,YAAYA,CAAC;EAAE1C,KAAK;EAAE2C,UAAU,GAAG,KAAK;EAAEC,KAAK;EAAEC;AAAS,CAAC,EAAE;EAAAC,EAAA;EACjF,MAAMC,QAAQ,GAAGzD,MAAM,CAAC,IAAI,CAAC;EAC7B,MAAMW,IAAI,GAAG0C,UAAU,KAAK,KAAK,IAAIA,UAAU,KAAK,KAAK,GAAG,KAAK,GAAG,IAAI;EAExEtD,SAAS,CAAC,MAAM;IACZ,IAAIwD,QAAQ,IAAI,CAAC7C,KAAK,EAAE;IAExB,IAAIgD,MAAM,GAAG,IAAI;IACjB,IAAIC,WAAW;IAEflD,aAAa,CAACC,KAAK,EAAEC,IAAI,CAAC,CACrBiD,IAAI,CAAE9C,KAAK,IAAK;MACb,IAAI,CAAC4C,MAAM,EAAE;QACTV,aAAa,CAACtC,KAAK,EAAEC,IAAI,CAAC;QAC1B;MACJ;MACAgD,WAAW,GAAG7C,KAAK;MACnB,IAAI2C,QAAQ,CAACI,OAAO,EAAE;QAClBJ,QAAQ,CAACI,OAAO,CAACC,SAAS,GAAGhD,KAAK,CAACQ,KAAK;QACxCmC,QAAQ,CAACI,OAAO,CAACE,IAAI,CAAC,CAAC,CAACC,KAAK,CAAC,MAAM,CAAE,CAAC,CAAC;MAC5C;IACJ,CAAC,CAAC,CACDA,KAAK,CAAElB,GAAG,IAAK;MACZ7B,OAAO,CAACgD,KAAK,CAAC,4BAA4BvD,KAAK,IAAIC,IAAI,GAAG,EAAEmC,GAAG,CAAC;IACpE,CAAC,CAAC;IAEN,OAAO,MAAM;MACTY,MAAM,GAAG,KAAK;MACd,IAAIC,WAAW,EAAE;QACbX,aAAa,CAACtC,KAAK,EAAEC,IAAI,CAAC;MAC9B;IACJ,CAAC;EACL,CAAC,EAAE,CAACD,KAAK,EAAEC,IAAI,EAAE4C,QAAQ,CAAC,CAAC;EAE3B,oBACIrD,OAAA;IAAKoD,KAAK,EAAE;MAAE,GAAGA,KAAK;MAAEY,QAAQ,EAAE,UAAU;MAAEC,UAAU,EAAE,MAAM;MAAEC,KAAK,EAAE,MAAM;MAAEC,MAAM,EAAE;IAAO,CAAE;IAAAC,QAAA,eAC9FpE,OAAA;MACIqE,GAAG,EAAEd,QAAS;MACde,QAAQ;MACRC,KAAK;MACLC,WAAW;MACXpB,KAAK,EAAE;QACHc,KAAK,EAAE,MAAM;QACbC,MAAM,EAAE,MAAM;QACdM,SAAS,EAAE;MACf;IAAE;MAAAC,QAAA,EAAAC,YAAA;MAAAC,UAAA;MAAAC,YAAA;IAAA,OACL;EAAC;IAAAH,QAAA,EAAAC,YAAA;IAAAC,UAAA;IAAAC,YAAA;EAAA,OACD,CAAC;AAEd;AAACvB,EAAA,CAjDuBJ,YAAY;AAAA4B,EAAA,GAAZ5B,YAAY;AAAA,IAAA4B,EAAA;AAAAC,YAAA,CAAAD,EAAA","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}