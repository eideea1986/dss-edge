{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef}from\"react\";/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */import{jsx as _jsx}from\"react/jsx-runtime\";const streamPool=new Map();/**\r\n * CONFIG FIX: Use the unified /rtc proxy on the main API port\r\n */const GO2RTC_API=\"\".concat(window.location.origin,\"/rtc\");async function acquireStream(camId){let type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"sub\";const key=\"\".concat(camId,\"_\").concat(type);if(streamPool.has(key)){const entry=streamPool.get(key);entry.refs++;console.log(\"[Go2RTCPlayer] Reusing stream for \".concat(key,\", refs: \").concat(entry.refs));return entry;}console.log(\"[Go2RTCPlayer] Creating new WebRTC connection for \".concat(key));const pc=new RTCPeerConnection({iceServers:[]});const media=new MediaStream();pc.ontrack=e=>{console.log(\"[Go2RTCPlayer] Track received for \".concat(key));media.addTrack(e.track);};pc.addTransceiver(\"video\",{direction:\"recvonly\"});try{const offer=await pc.createOffer();await pc.setLocalDescription(offer);const res=await fetch(\"\".concat(GO2RTC_API,\"/api/webrtc?src=\").concat(key),{method:\"POST\",headers:{\"Content-Type\":\"application/sdp\"},body:offer.sdp});if(!res.ok){throw new Error(\"WebRTC signaling failed: \".concat(res.status));}const answer=await res.text();await pc.setRemoteDescription({type:\"answer\",sdp:answer});const entry={pc,media,refs:1};streamPool.set(key,entry);return entry;}catch(err){pc.close();throw err;}}function releaseStream(camId){let type=arguments.length>1&&arguments[1]!==undefined?arguments[1]:\"sub\";const key=\"\".concat(camId,\"_\").concat(type);const entry=streamPool.get(key);if(!entry)return;entry.refs--;console.log(\"[Go2RTCPlayer] Released stream for \".concat(key,\", refs: \").concat(entry.refs));// 15s grace period to prevent flickering during tab switches\nif(entry.refs<=0){setTimeout(()=>{const currentEntry=streamPool.get(key);if(currentEntry&&currentEntry.refs<=0){console.log(\"[Go2RTCPlayer] Closing idle connection for \".concat(key));currentEntry.pc.close();streamPool.delete(key);}},15000);}}/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */export default function Go2RTCPlayer(_ref){let{camId,streamType=\"sub\",style,isHidden}=_ref;const videoRef=useRef(null);const type=streamType==='low'||streamType==='sub'?'sub':'hd';useEffect(()=>{if(isHidden||!camId)return;let active=true;let streamEntry;acquireStream(camId,type).then(entry=>{if(!active){releaseStream(camId,type);return;}streamEntry=entry;if(videoRef.current){videoRef.current.srcObject=entry.media;videoRef.current.play().catch(()=>{});}}).catch(err=>{console.error(\"[Go2RTCPlayer] Error for \".concat(camId,\"_\").concat(type,\":\"),err);});return()=>{active=false;if(streamEntry){releaseStream(camId,type);}};},[camId,type,isHidden]);return/*#__PURE__*/_jsx(\"div\",{style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\",width:\"100%\",height:\"100%\"}),children:/*#__PURE__*/_jsx(\"video\",{ref:videoRef,autoPlay:true,muted:true,playsInline:true,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\"}})});}","map":{"version":3,"names":["React","useEffect","useRef","jsx","_jsx","streamPool","Map","GO2RTC_API","concat","window","location","origin","acquireStream","camId","type","arguments","length","undefined","key","has","entry","get","refs","console","log","pc","RTCPeerConnection","iceServers","media","MediaStream","ontrack","e","addTrack","track","addTransceiver","direction","offer","createOffer","setLocalDescription","res","fetch","method","headers","body","sdp","ok","Error","status","answer","text","setRemoteDescription","set","err","close","releaseStream","setTimeout","currentEntry","delete","Go2RTCPlayer","_ref","streamType","style","isHidden","videoRef","active","streamEntry","then","current","srcObject","play","catch","error","_objectSpread","position","background","width","height","children","ref","autoPlay","muted","playsInline","objectFit"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef } from \"react\";\r\n\r\n/**\r\n * GLOBAL STREAM POOL (session-scoped, NU React-scoped)\r\n */\r\nconst streamPool = new Map();\r\n\r\n/**\r\n * CONFIG FIX: Use the unified /rtc proxy on the main API port\r\n */\r\nconst GO2RTC_API = `${window.location.origin}/rtc`;\r\n\r\nasync function acquireStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n\r\n    if (streamPool.has(key)) {\r\n        const entry = streamPool.get(key);\r\n        entry.refs++;\r\n        console.log(`[Go2RTCPlayer] Reusing stream for ${key}, refs: ${entry.refs}`);\r\n        return entry;\r\n    }\r\n\r\n    console.log(`[Go2RTCPlayer] Creating new WebRTC connection for ${key}`);\r\n    const pc = new RTCPeerConnection({ iceServers: [] });\r\n    const media = new MediaStream();\r\n\r\n    pc.ontrack = (e) => {\r\n        console.log(`[Go2RTCPlayer] Track received for ${key}`);\r\n        media.addTrack(e.track);\r\n    };\r\n\r\n    pc.addTransceiver(\"video\", { direction: \"recvonly\" });\r\n\r\n    try {\r\n        const offer = await pc.createOffer();\r\n        await pc.setLocalDescription(offer);\r\n\r\n        const res = await fetch(\r\n            `${GO2RTC_API}/api/webrtc?src=${key}`,\r\n            {\r\n                method: \"POST\",\r\n                headers: { \"Content-Type\": \"application/sdp\" },\r\n                body: offer.sdp\r\n            }\r\n        );\r\n\r\n        if (!res.ok) {\r\n            throw new Error(`WebRTC signaling failed: ${res.status}`);\r\n        }\r\n\r\n        const answer = await res.text();\r\n        await pc.setRemoteDescription({ type: \"answer\", sdp: answer });\r\n\r\n        const entry = {\r\n            pc,\r\n            media,\r\n            refs: 1\r\n        };\r\n\r\n        streamPool.set(key, entry);\r\n        return entry;\r\n    } catch (err) {\r\n        pc.close();\r\n        throw err;\r\n    }\r\n}\r\n\r\nfunction releaseStream(camId, type = \"sub\") {\r\n    const key = `${camId}_${type}`;\r\n    const entry = streamPool.get(key);\r\n    if (!entry) return;\r\n\r\n    entry.refs--;\r\n    console.log(`[Go2RTCPlayer] Released stream for ${key}, refs: ${entry.refs}`);\r\n\r\n    // 15s grace period to prevent flickering during tab switches\r\n    if (entry.refs <= 0) {\r\n        setTimeout(() => {\r\n            const currentEntry = streamPool.get(key);\r\n            if (currentEntry && currentEntry.refs <= 0) {\r\n                console.log(`[Go2RTCPlayer] Closing idle connection for ${key}`);\r\n                currentEntry.pc.close();\r\n                streamPool.delete(key);\r\n            }\r\n        }, 15000);\r\n    }\r\n}\r\n\r\n/**\r\n * UI COMPONENT – DOAR ATAȘARE\r\n */\r\nexport default function Go2RTCPlayer({ camId, streamType = \"sub\", style, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const type = streamType === 'low' || streamType === 'sub' ? 'sub' : 'hd';\r\n\r\n    useEffect(() => {\r\n        if (isHidden || !camId) return;\r\n\r\n        let active = true;\r\n        let streamEntry;\r\n\r\n        acquireStream(camId, type)\r\n            .then((entry) => {\r\n                if (!active) {\r\n                    releaseStream(camId, type);\r\n                    return;\r\n                }\r\n                streamEntry = entry;\r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = entry.media;\r\n                    videoRef.current.play().catch(() => { });\r\n                }\r\n            })\r\n            .catch((err) => {\r\n                console.error(`[Go2RTCPlayer] Error for ${camId}_${type}:`, err);\r\n            });\r\n\r\n        return () => {\r\n            active = false;\r\n            if (streamEntry) {\r\n                releaseStream(camId, type);\r\n            }\r\n        };\r\n    }, [camId, type, isHidden]);\r\n\r\n    return (\r\n        <div style={{ ...style, position: \"relative\", background: \"#000\", width: \"100%\", height: \"100%\" }}>\r\n            <video\r\n                ref={videoRef}\r\n                autoPlay\r\n                muted\r\n                playsInline\r\n                style={{\r\n                    width: \"100%\",\r\n                    height: \"100%\",\r\n                    objectFit: \"fill\"\r\n                }}\r\n            />\r\n        </div>\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}