{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function Go2RTCPlayer(_ref){let{camId,streamType='hd',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const pcRef=useRef(null);const[status,setStatus]=useState(\"init\");const suffix=streamType==='low'||streamType==='sub'?'sub':'hd';const streamName=\"\".concat(camId,\"_\").concat(suffix);useEffect(()=>{if(isHidden||!camId)return;let mounted=true;const connect=async()=>{setStatus(\"connecting\");if(pcRef.current){pcRef.current.close();pcRef.current=null;}const pc=new RTCPeerConnection({iceServers:[]});pcRef.current=pc;pc.ontrack=event=>{if(mounted&&videoRef.current){videoRef.current.srcObject=event.streams[0];videoRef.current.play().catch(()=>{});setStatus(\"playing\");}};pc.addTransceiver('video',{direction:'recvonly'});try{const offer=await pc.createOffer();await pc.setLocalDescription(offer);const apiUrl=\"http://\".concat(window.location.hostname,\":8085/api/webrtc?src=\").concat(streamName);const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/sdp'},body:offer.sdp});if(!res.ok)throw new Error(\"Failed: \".concat(res.status));const answer=await res.text();if(mounted&&pcRef.current){await pc.setRemoteDescription({type:'answer',sdp:answer});}}catch(err){console.error(\"[WebRTC] Error for \".concat(streamName,\":\"),err);if(mounted)setStatus(\"error\");}};connect();return()=>{mounted=false;if(pcRef.current){pcRef.current.close();pcRef.current=null;}};},[camId,streamName,isHidden]);return/*#__PURE__*/_jsxs(\"div\",{style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[/*#__PURE__*/_jsx(\"video\",{ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\"},playsInline:true,muted:true,autoPlay:true}),status==='connecting'&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:\"50%\",left:\"50%\",transform:\"translate(-50%, -50%)\",color:\"rgba(255,255,255,0.5)\",fontSize:10},children:\"Connecting...\"}),status==='error'&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:\"50%\",left:\"50%\",transform:\"translate(-50%, -50%)\",color:\"red\",fontSize:10},children:\"Error\"})]});}export default/*#__PURE__*/React.memo(Go2RTCPlayer);","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","Go2RTCPlayer","_ref","camId","streamType","style","onClick","onDoubleClick","isHidden","videoRef","pcRef","status","setStatus","suffix","streamName","concat","mounted","connect","current","close","pc","RTCPeerConnection","iceServers","ontrack","event","srcObject","streams","play","catch","addTransceiver","direction","offer","createOffer","setLocalDescription","apiUrl","window","location","hostname","res","fetch","method","headers","body","sdp","ok","Error","answer","text","setRemoteDescription","type","err","console","error","_objectSpread","position","background","children","ref","width","height","objectFit","playsInline","muted","autoPlay","top","left","transform","color","fontSize","memo"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\nfunction Go2RTCPlayer({ camId, streamType = 'hd', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const pcRef = useRef(null);\r\n    const [status, setStatus] = useState(\"init\");\r\n\r\n    const suffix = streamType === 'low' || streamType === 'sub' ? 'sub' : 'hd';\r\n    const streamName = `${camId}_${suffix}`;\r\n\r\n    useEffect(() => {\r\n        if (isHidden || !camId) return;\r\n\r\n        let mounted = true;\r\n\r\n        const connect = async () => {\r\n            setStatus(\"connecting\");\r\n\r\n            if (pcRef.current) {\r\n                pcRef.current.close();\r\n                pcRef.current = null;\r\n            }\r\n\r\n            const pc = new RTCPeerConnection({ iceServers: [] });\r\n            pcRef.current = pc;\r\n\r\n            pc.ontrack = (event) => {\r\n                if (mounted && videoRef.current) {\r\n                    videoRef.current.srcObject = event.streams[0];\r\n                    videoRef.current.play().catch(() => { });\r\n                    setStatus(\"playing\");\r\n                }\r\n            };\r\n\r\n            pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n            try {\r\n                const offer = await pc.createOffer();\r\n                await pc.setLocalDescription(offer);\r\n\r\n                const apiUrl = `http://${window.location.hostname}:8085/api/webrtc?src=${streamName}`;\r\n                const res = await fetch(apiUrl, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/sdp' },\r\n                    body: offer.sdp\r\n                });\r\n\r\n                if (!res.ok) throw new Error(`Failed: ${res.status}`);\r\n\r\n                const answer = await res.text();\r\n                if (mounted && pcRef.current) {\r\n                    await pc.setRemoteDescription({ type: 'answer', sdp: answer });\r\n                }\r\n            } catch (err) {\r\n                console.error(`[WebRTC] Error for ${streamName}:`, err);\r\n                if (mounted) setStatus(\"error\");\r\n            }\r\n        };\r\n\r\n        connect();\r\n\r\n        return () => {\r\n            mounted = false;\r\n            if (pcRef.current) {\r\n                pcRef.current.close();\r\n                pcRef.current = null;\r\n            }\r\n        };\r\n    }, [camId, streamName, isHidden]);\r\n\r\n    return (\r\n        <div style={{ ...style, position: \"relative\", background: \"#000\" }}\r\n            onClick={onClick} onDoubleClick={onDoubleClick}>\r\n            <video\r\n                ref={videoRef}\r\n                style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\" }}\r\n                playsInline muted autoPlay\r\n            />\r\n            {status === 'connecting' && (\r\n                <div style={{ position: \"absolute\", top: \"50%\", left: \"50%\", transform: \"translate(-50%, -50%)\", color: \"rgba(255,255,255,0.5)\", fontSize: 10 }}>\r\n                    Connecting...\r\n                </div>\r\n            )}\r\n            {status === 'error' && (\r\n                <div style={{ position: \"absolute\", top: \"50%\", left: \"50%\", transform: \"translate(-50%, -50%)\", color: \"red\", fontSize: 10 }}>\r\n                    Error\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default React.memo(Go2RTCPlayer);\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}