{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";function MSEPlayer(_ref){let{camId,streamType='hd',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const wsRef=useRef(null);const[status,setStatus]=useState(\"init\");// Mapping stream type\nconst suffix=streamType==='low'?'sub':streamType==='hd'?'hd':streamType;const streamName=\"\".concat(camId,\"_\").concat(suffix);useEffect(()=>{if(isHidden)return;setStatus(\"connecting\");const video=videoRef.current;if(!video)return;const mse=new MediaSource();video.src=URL.createObjectURL(mse);// Auto-play attempt\nconst tryPlay=()=>{if(video.paused)video.play().catch(()=>{});};video.addEventListener('canplay',tryPlay);const cleanup=()=>{if(wsRef.current){wsRef.current.close();wsRef.current=null;}if(video.src){URL.revokeObjectURL(video.src);video.src='';}video.removeEventListener('canplay',tryPlay);};mse.addEventListener('sourceopen',()=>{const proto=window.location.protocol==='https:'?'wss:':'ws:';// Use Go2RTC API for MSE/fMP4 over WebSocket\nconst wsUrl=\"\".concat(proto,\"//\").concat(window.location.host,\"/rtc/api/ws?src=\").concat(streamName);const ws=new WebSocket(wsUrl);ws.binaryType='arraybuffer';wsRef.current=ws;ws.onopen=()=>{console.log(\"[MSE] Connected to \".concat(streamName));setStatus(\"playing\");};ws.onclose=()=>{console.log(\"[MSE] Disconnected from \".concat(streamName));setStatus(\"disconnected\");};ws.onerror=e=>{console.error(\"[MSE] WS Error\",e);};let sb=null;const queue=[];const processQueue=()=>{if(sb&&!sb.updating&&queue.length>0){try{sb.appendBuffer(queue.shift());}catch(e){console.error(\"[MSE] Append Error\",e);}}};ws.onmessage=event=>{const data=event.data;if(!sb){// Initialize SourceBuffer on first chunk.\n// Ideally we should know codec. Assuming standard H.264 High Profile (avc1.6400xx)\n// But 'avc1.64001E' (High) or 'avc1.42E01E' (Baseline) are common.\n// Safe bet for modern browsers: 'video/mp4; codecs=\"avc1.64001E\"'\nconst mime='video/mp4; codecs=\"avc1.64001E\"';if(MediaSource.isTypeSupported(mime)){try{sb=mse.addSourceBuffer(mime);sb.mode='segments';sb.addEventListener('updateend',processQueue);}catch(e){console.error(\"[MSE] Failed to add SourceBuffer\",e);ws.close();return;}}else{console.error(\"[MSE] Codec not supported: \"+mime);ws.close();return;}}if(sb){queue.push(data);processQueue();}};});return cleanup;},[camId,streamName,isHidden]);return/*#__PURE__*/_jsxs(\"div\",{className:\"mse-player\",style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\",width:\"100%\",height:\"100%\",overflow:\"hidden\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[/*#__PURE__*/_jsx(\"video\",{ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"fill\",display:\"block\"},playsInline:true,muted:true,autoPlay:true}),status!=='playing'&&/*#__PURE__*/_jsxs(\"div\",{style:{position:\"absolute\",top:10,left:10,color:\"rgba(255,255,255,0.5)\",fontSize:10,pointerEvents:\"none\"},children:[\"MSE: \",status]})]});}export default/*#__PURE__*/React.memo(MSEPlayer);","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","MSEPlayer","_ref","camId","streamType","style","onClick","onDoubleClick","isHidden","videoRef","wsRef","status","setStatus","suffix","streamName","concat","video","current","mse","MediaSource","src","URL","createObjectURL","tryPlay","paused","play","catch","addEventListener","cleanup","close","revokeObjectURL","removeEventListener","proto","window","location","protocol","wsUrl","host","ws","WebSocket","binaryType","onopen","console","log","onclose","onerror","e","error","sb","queue","processQueue","updating","length","appendBuffer","shift","onmessage","event","data","mime","isTypeSupported","addSourceBuffer","mode","push","className","_objectSpread","position","background","width","height","overflow","children","ref","objectFit","display","playsInline","muted","autoPlay","top","left","color","fontSize","pointerEvents","memo"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/MSEPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\nfunction MSEPlayer({ camId, streamType = 'hd', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const wsRef = useRef(null);\r\n    const [status, setStatus] = useState(\"init\");\r\n\r\n    // Mapping stream type\r\n    const suffix = streamType === 'low' ? 'sub' : streamType === 'hd' ? 'hd' : streamType;\r\n    const streamName = `${camId}_${suffix}`;\r\n\r\n    useEffect(() => {\r\n        if (isHidden) return;\r\n\r\n        setStatus(\"connecting\");\r\n        const video = videoRef.current;\r\n        if (!video) return;\r\n\r\n        const mse = new MediaSource();\r\n        video.src = URL.createObjectURL(mse);\r\n\r\n        // Auto-play attempt\r\n        const tryPlay = () => {\r\n            if (video.paused) video.play().catch(() => { });\r\n        };\r\n        video.addEventListener('canplay', tryPlay);\r\n\r\n        const cleanup = () => {\r\n            if (wsRef.current) {\r\n                wsRef.current.close();\r\n                wsRef.current = null;\r\n            }\r\n            if (video.src) {\r\n                URL.revokeObjectURL(video.src);\r\n                video.src = '';\r\n            }\r\n            video.removeEventListener('canplay', tryPlay);\r\n        };\r\n\r\n        mse.addEventListener('sourceopen', () => {\r\n            const proto = window.location.protocol === 'https:' ? 'wss:' : 'ws:';\r\n            // Use Go2RTC API for MSE/fMP4 over WebSocket\r\n            const wsUrl = `${proto}//${window.location.host}/rtc/api/ws?src=${streamName}`;\r\n\r\n            const ws = new WebSocket(wsUrl);\r\n            ws.binaryType = 'arraybuffer';\r\n            wsRef.current = ws;\r\n\r\n            ws.onopen = () => {\r\n                console.log(`[MSE] Connected to ${streamName}`);\r\n                setStatus(\"playing\");\r\n            };\r\n\r\n            ws.onclose = () => {\r\n                console.log(`[MSE] Disconnected from ${streamName}`);\r\n                setStatus(\"disconnected\");\r\n            };\r\n\r\n            ws.onerror = (e) => {\r\n                console.error(\"[MSE] WS Error\", e);\r\n            };\r\n\r\n            let sb = null;\r\n            const queue = [];\r\n\r\n            const processQueue = () => {\r\n                if (sb && !sb.updating && queue.length > 0) {\r\n                    try {\r\n                        sb.appendBuffer(queue.shift());\r\n                    } catch (e) {\r\n                        console.error(\"[MSE] Append Error\", e);\r\n                    }\r\n                }\r\n            };\r\n\r\n            ws.onmessage = (event) => {\r\n                const data = event.data;\r\n\r\n                if (!sb) {\r\n                    // Initialize SourceBuffer on first chunk.\r\n                    // Ideally we should know codec. Assuming standard H.264 High Profile (avc1.6400xx)\r\n                    // But 'avc1.64001E' (High) or 'avc1.42E01E' (Baseline) are common.\r\n                    // Safe bet for modern browsers: 'video/mp4; codecs=\"avc1.64001E\"'\r\n                    const mime = 'video/mp4; codecs=\"avc1.64001E\"';\r\n                    if (MediaSource.isTypeSupported(mime)) {\r\n                        try {\r\n                            sb = mse.addSourceBuffer(mime);\r\n                            sb.mode = 'segments';\r\n                            sb.addEventListener('updateend', processQueue);\r\n                        } catch (e) {\r\n                            console.error(\"[MSE] Failed to add SourceBuffer\", e);\r\n                            ws.close();\r\n                            return;\r\n                        }\r\n                    } else {\r\n                        console.error(\"[MSE] Codec not supported: \" + mime);\r\n                        ws.close();\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                if (sb) {\r\n                    queue.push(data);\r\n                    processQueue();\r\n                }\r\n            };\r\n        });\r\n\r\n        return cleanup;\r\n    }, [camId, streamName, isHidden]);\r\n\r\n    return (\r\n        <div className=\"mse-player\" style={{ ...style, position: \"relative\", background: \"#000\", width: \"100%\", height: \"100%\", overflow: \"hidden\" }}\r\n            onClick={onClick} onDoubleClick={onDoubleClick}>\r\n            <video\r\n                ref={videoRef}\r\n                style={{ width: \"100%\", height: \"100%\", objectFit: \"fill\", display: \"block\" }}\r\n                playsInline muted autoPlay\r\n            />\r\n            {status !== 'playing' && (\r\n                <div style={{ position: \"absolute\", top: 10, left: 10, color: \"rgba(255,255,255,0.5)\", fontSize: 10, pointerEvents: \"none\" }}>\r\n                    MSE: {status}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n\r\nexport default React.memo(MSEPlayer);\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}