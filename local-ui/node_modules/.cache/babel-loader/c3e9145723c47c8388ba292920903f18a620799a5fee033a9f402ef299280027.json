{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";export class MediaStreamManager{constructor(){this.streams=new Map();// key: streamName -> { pc, mediaStream, consumers: 0 }\n// Config\nthis.GO2RTC_API_PORT=8085;}// Fixed port for signaling (API)\nstatic getInstance(){if(!MediaStreamManager.instance){MediaStreamManager.instance=new MediaStreamManager();}return MediaStreamManager.instance;}async getStream(camId){let streamType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'sub';const suffix=streamType==='hd'?'hd':'sub';const streamName=\"\".concat(camId,\"_\").concat(suffix);if(!this.streams.has(streamName)){console.log(\"[StreamManager] Creating new session for \".concat(streamName));const streamData=await this._createWebRTCConnection(streamName);this.streams.set(streamName,_objectSpread(_objectSpread({},streamData),{},{consumers:0,lastUsed:Date.now()}));}const session=this.streams.get(streamName);session.consumers++;session.lastUsed=Date.now();console.log(\"[StreamManager] Attached to \".concat(streamName,\". Consumers: \").concat(session.consumers));return session.mediaStream;}releaseStream(camId){let streamType=arguments.length>1&&arguments[1]!==undefined?arguments[1]:'sub';const suffix=streamType==='hd'?'hd':'sub';const streamName=\"\".concat(camId,\"_\").concat(suffix);if(this.streams.has(streamName)){const session=this.streams.get(streamName);session.consumers--;console.log(\"[StreamManager] Released \".concat(streamName,\". Remaining: \").concat(session.consumers));// OPTIONAL: Keep alive for X seconds to allow quick tab switching\n// For now, we keep it alive until explicit cleanup or page reload\n// if (session.consumers <= 0) this._closeStream(streamName);\n}}async _createWebRTCConnection(streamName){return new Promise(async(resolve,reject)=>{const pc=new RTCPeerConnection({iceServers:[]// Force LAN\n});const transceivers=pc.addTransceiver('video',{direction:'recvonly'});pc.ontrack=event=>{resolve({pc,mediaStream:event.streams[0]});};const offer=await pc.createOffer();await pc.setLocalDescription(offer);try{// Use explicit hostname to support remote access\nconst apiUrl=\"http://\".concat(window.location.hostname,\":\").concat(this.GO2RTC_API_PORT,\"/api/webrtc?src=\").concat(streamName);const res=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/sdp'},body:pc.localDescription.sdp});if(!res.ok)throw new Error(\"Signaling failed: \".concat(res.status));const answer=await res.text();await pc.setRemoteDescription({type:'answer',sdp:answer});}catch(e){pc.close();reject(e);}});}// Call this if needed to force cleanup (e.g. user logout)\ncloseAll(){this.streams.forEach(s=>s.pc.close());this.streams.clear();}}MediaStreamManager.instance=null;","map":{"version":3,"names":["MediaStreamManager","constructor","streams","Map","GO2RTC_API_PORT","getInstance","instance","getStream","camId","streamType","arguments","length","undefined","suffix","streamName","concat","has","console","log","streamData","_createWebRTCConnection","set","_objectSpread","consumers","lastUsed","Date","now","session","get","mediaStream","releaseStream","Promise","resolve","reject","pc","RTCPeerConnection","iceServers","transceivers","addTransceiver","direction","ontrack","event","offer","createOffer","setLocalDescription","apiUrl","window","location","hostname","res","fetch","method","headers","body","localDescription","sdp","ok","Error","status","answer","text","setRemoteDescription","type","e","close","closeAll","forEach","s","clear"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/MediaStreamManager.js"],"sourcesContent":["export class MediaStreamManager {\r\n    static instance = null;\r\n    streams = new Map(); // key: streamName -> { pc, mediaStream, consumers: 0 }\r\n\r\n    // Config\r\n    GO2RTC_API_PORT = 8085; // Fixed port for signaling (API)\r\n\r\n    static getInstance() {\r\n        if (!MediaStreamManager.instance) {\r\n            MediaStreamManager.instance = new MediaStreamManager();\r\n        }\r\n        return MediaStreamManager.instance;\r\n    }\r\n\r\n    async getStream(camId, streamType = 'sub') {\r\n        const suffix = streamType === 'hd' ? 'hd' : 'sub';\r\n        const streamName = `${camId}_${suffix}`;\r\n\r\n        if (!this.streams.has(streamName)) {\r\n            console.log(`[StreamManager] Creating new session for ${streamName}`);\r\n            const streamData = await this._createWebRTCConnection(streamName);\r\n            this.streams.set(streamName, {\r\n                ...streamData,\r\n                consumers: 0,\r\n                lastUsed: Date.now()\r\n            });\r\n        }\r\n\r\n        const session = this.streams.get(streamName);\r\n        session.consumers++;\r\n        session.lastUsed = Date.now();\r\n        console.log(`[StreamManager] Attached to ${streamName}. Consumers: ${session.consumers}`);\r\n\r\n        return session.mediaStream;\r\n    }\r\n\r\n    releaseStream(camId, streamType = 'sub') {\r\n        const suffix = streamType === 'hd' ? 'hd' : 'sub';\r\n        const streamName = `${camId}_${suffix}`;\r\n\r\n        if (this.streams.has(streamName)) {\r\n            const session = this.streams.get(streamName);\r\n            session.consumers--;\r\n            console.log(`[StreamManager] Released ${streamName}. Remaining: ${session.consumers}`);\r\n\r\n            // OPTIONAL: Keep alive for X seconds to allow quick tab switching\r\n            // For now, we keep it alive until explicit cleanup or page reload\r\n            // if (session.consumers <= 0) this._closeStream(streamName);\r\n        }\r\n    }\r\n\r\n    async _createWebRTCConnection(streamName) {\r\n        return new Promise(async (resolve, reject) => {\r\n            const pc = new RTCPeerConnection({\r\n                iceServers: [] // Force LAN\r\n            });\r\n\r\n            const transceivers = pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n            pc.ontrack = (event) => {\r\n                resolve({ pc, mediaStream: event.streams[0] });\r\n            };\r\n\r\n            const offer = await pc.createOffer();\r\n            await pc.setLocalDescription(offer);\r\n\r\n            try {\r\n                // Use explicit hostname to support remote access\r\n                const apiUrl = `http://${window.location.hostname}:${this.GO2RTC_API_PORT}/api/webrtc?src=${streamName}`;\r\n                const res = await fetch(apiUrl, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/sdp' },\r\n                    body: pc.localDescription.sdp\r\n                });\r\n\r\n                if (!res.ok) throw new Error(`Signaling failed: ${res.status}`);\r\n\r\n                const answer = await res.text();\r\n                await pc.setRemoteDescription({ type: 'answer', sdp: answer });\r\n            } catch (e) {\r\n                pc.close();\r\n                reject(e);\r\n            }\r\n        });\r\n    }\r\n\r\n    // Call this if needed to force cleanup (e.g. user logout)\r\n    closeAll() {\r\n        this.streams.forEach(s => s.pc.close());\r\n        this.streams.clear();\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}