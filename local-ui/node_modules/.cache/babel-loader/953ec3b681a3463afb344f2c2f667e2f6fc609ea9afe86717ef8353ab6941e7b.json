{"ast":null,"code":"import Hls from'hls.js';export default class PlaybackCoreV2{constructor(videoElement,camId){let baseUrl=arguments.length>2&&arguments[2]!==undefined?arguments[2]:'/api';this.video=videoElement;this.camId=camId;this.baseUrl=baseUrl;this.hls=null;// Internal State for Clock Sync\nthis.currentFragPDT=0;this.currentFragStartPTS=0;this.isReady=false;}setSegments(segments){// Optional: Keep for reference if needed\n}start(startEpochMs){console.log(\"[HLS] START Request: \".concat(new Date(startEpochMs).toLocaleTimeString()));// Clean up previous\nif(this.hls){this.hls.destroy();this.hls=null;}// Calculate Playlist URL (VOD Window)\n// Start from requested time, going forward 6 hours (or until end of day)\n// This keeps playlists reasonably small but allows continuous playback\nconst startTime=startEpochMs;const endTime=startTime+12*60*60*1000;// 12h window\nconst playlistUrl=\"\".concat(this.baseUrl,\"/playback/playlist/\").concat(this.camId,\".m3u8?start=\").concat(startTime,\"&end=\").concat(endTime);if(Hls.isSupported()){this.hls=new Hls({debug:false,enableWorker:true,manifestLoadingTimeOut:10000,fragLoadingTimeOut:20000,startFragPrefetch:true});this.hls.loadSource(playlistUrl);this.hls.attachMedia(this.video);this.hls.on(Hls.Events.MANIFEST_PARSED,(event,data)=>{console.log(\"[HLS] Manifest Parsed. Levels: \".concat(data.levels.length));this.videofreeze=false;this.video.play().catch(e=>console.warn(\"Autoplay blocked\",e));});// CLOCK SYNC: Capture Program Date Time from Fragment\nthis.hls.on(Hls.Events.FRAG_CHANGED,(event,data)=>{if(data.frag){if(data.frag.programDateTime){this.currentFragPDT=data.frag.programDateTime;this.currentFragStartPTS=data.frag.start;// console.log(`[HLS] Sync Time: ${new Date(this.currentFragPDT).toLocaleTimeString()}`);\n}}});this.hls.on(Hls.Events.ERROR,(event,data)=>{if(data.fatal){console.error(\"[HLS] FATAL ERROR: \".concat(data.type));switch(data.type){case Hls.ErrorTypes.NETWORK_ERROR:console.log(\"[HLS] Trying to recover network error...\");this.hls.startLoad();break;case Hls.ErrorTypes.MEDIA_ERROR:console.log(\"[HLS] Trying to recover media error...\");this.hls.recoverMediaError();break;default:this.hls.destroy();break;}}});}else if(this.video.canPlayType('application/vnd.apple.mpegurl')){// Safari Native HLS\nthis.video.src=playlistUrl;this.video.addEventListener('loadedmetadata',()=>{this.video.play();});}}seekTo(ts){// HLS VOD Seek via Playlist Reload\n// This ensures backend generates the correct playlist for the new time\nconsole.log(\"[HLS] SEEK -> \".concat(new Date(ts).toLocaleTimeString()));this.video.pause();this.start(ts);}getCurrentEpochMs(){// 1. HLS.js with PDT\nif(this.currentFragPDT&&this.hls){const timeInFrag=this.video.currentTime-this.currentFragStartPTS;const absoluteTime=this.currentFragPDT+timeInFrag*1000;return absoluteTime;}// 2. Safari Native\nif(this.video.getStartDate&&typeof this.video.getStartDate==='function'){const sd=this.video.getStartDate();if(sd&&!isNaN(sd.getTime())){return sd.getTime()+this.video.currentTime*1000;}}return 0;}destroy(){if(this.hls){this.hls.destroy();this.hls=null;}if(this.video){this.video.pause();this.video.removeAttribute('src');this.video.load();}}}","map":{"version":3,"names":["Hls","PlaybackCoreV2","constructor","videoElement","camId","baseUrl","arguments","length","undefined","video","hls","currentFragPDT","currentFragStartPTS","isReady","setSegments","segments","start","startEpochMs","console","log","concat","Date","toLocaleTimeString","destroy","startTime","endTime","playlistUrl","isSupported","debug","enableWorker","manifestLoadingTimeOut","fragLoadingTimeOut","startFragPrefetch","loadSource","attachMedia","on","Events","MANIFEST_PARSED","event","data","levels","videofreeze","play","catch","e","warn","FRAG_CHANGED","frag","programDateTime","ERROR","fatal","error","type","ErrorTypes","NETWORK_ERROR","startLoad","MEDIA_ERROR","recoverMediaError","canPlayType","src","addEventListener","seekTo","ts","pause","getCurrentEpochMs","timeInFrag","currentTime","absoluteTime","getStartDate","sd","isNaN","getTime","removeAttribute","load"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/services/PlaybackCoreV2.js"],"sourcesContent":["import Hls from 'hls.js';\r\n\r\nexport default class PlaybackCoreV2 {\r\n    constructor(videoElement, camId, baseUrl = '/api') {\r\n        this.video = videoElement;\r\n        this.camId = camId;\r\n        this.baseUrl = baseUrl;\r\n        this.hls = null;\r\n\r\n        // Internal State for Clock Sync\r\n        this.currentFragPDT = 0;\r\n        this.currentFragStartPTS = 0;\r\n        this.isReady = false;\r\n    }\r\n\r\n    setSegments(segments) {\r\n        // Optional: Keep for reference if needed\r\n    }\r\n\r\n    start(startEpochMs) {\r\n        console.log(`[HLS] START Request: ${new Date(startEpochMs).toLocaleTimeString()}`);\r\n\r\n        // Clean up previous\r\n        if (this.hls) {\r\n            this.hls.destroy();\r\n            this.hls = null;\r\n        }\r\n\r\n        // Calculate Playlist URL (VOD Window)\r\n        // Start from requested time, going forward 6 hours (or until end of day)\r\n        // This keeps playlists reasonably small but allows continuous playback\r\n        const startTime = startEpochMs;\r\n        const endTime = startTime + (12 * 60 * 60 * 1000); // 12h window\r\n\r\n        const playlistUrl = `${this.baseUrl}/playback/playlist/${this.camId}.m3u8?start=${startTime}&end=${endTime}`;\r\n\r\n        if (Hls.isSupported()) {\r\n            this.hls = new Hls({\r\n                debug: false,\r\n                enableWorker: true,\r\n                manifestLoadingTimeOut: 10000,\r\n                fragLoadingTimeOut: 20000,\r\n                startFragPrefetch: true\r\n            });\r\n\r\n            this.hls.loadSource(playlistUrl);\r\n            this.hls.attachMedia(this.video);\r\n\r\n            this.hls.on(Hls.Events.MANIFEST_PARSED, (event, data) => {\r\n                console.log(`[HLS] Manifest Parsed. Levels: ${data.levels.length}`);\r\n                this.videofreeze = false;\r\n                this.video.play().catch(e => console.warn(\"Autoplay blocked\", e));\r\n            });\r\n\r\n            // CLOCK SYNC: Capture Program Date Time from Fragment\r\n            this.hls.on(Hls.Events.FRAG_CHANGED, (event, data) => {\r\n                if (data.frag) {\r\n                    if (data.frag.programDateTime) {\r\n                        this.currentFragPDT = data.frag.programDateTime;\r\n                        this.currentFragStartPTS = data.frag.start;\r\n                        // console.log(`[HLS] Sync Time: ${new Date(this.currentFragPDT).toLocaleTimeString()}`);\r\n                    }\r\n                }\r\n            });\r\n\r\n            this.hls.on(Hls.Events.ERROR, (event, data) => {\r\n                if (data.fatal) {\r\n                    console.error(`[HLS] FATAL ERROR: ${data.type}`);\r\n                    switch (data.type) {\r\n                        case Hls.ErrorTypes.NETWORK_ERROR:\r\n                            console.log(\"[HLS] Trying to recover network error...\");\r\n                            this.hls.startLoad();\r\n                            break;\r\n                        case Hls.ErrorTypes.MEDIA_ERROR:\r\n                            console.log(\"[HLS] Trying to recover media error...\");\r\n                            this.hls.recoverMediaError();\r\n                            break;\r\n                        default:\r\n                            this.hls.destroy();\r\n                            break;\r\n                    }\r\n                }\r\n            });\r\n\r\n        } else if (this.video.canPlayType('application/vnd.apple.mpegurl')) {\r\n            // Safari Native HLS\r\n            this.video.src = playlistUrl;\r\n            this.video.addEventListener('loadedmetadata', () => {\r\n                this.video.play();\r\n            });\r\n        }\r\n    }\r\n\r\n    seekTo(ts) {\r\n        // HLS VOD Seek via Playlist Reload\r\n        // This ensures backend generates the correct playlist for the new time\r\n        console.log(`[HLS] SEEK -> ${new Date(ts).toLocaleTimeString()}`);\r\n        this.video.pause();\r\n        this.start(ts);\r\n    }\r\n\r\n    getCurrentEpochMs() {\r\n        // 1. HLS.js with PDT\r\n        if (this.currentFragPDT && this.hls) {\r\n            const timeInFrag = this.video.currentTime - this.currentFragStartPTS;\r\n            const absoluteTime = this.currentFragPDT + (timeInFrag * 1000);\r\n            return absoluteTime;\r\n        }\r\n\r\n        // 2. Safari Native\r\n        if (this.video.getStartDate && typeof this.video.getStartDate === 'function') {\r\n            const sd = this.video.getStartDate();\r\n            if (sd && !isNaN(sd.getTime())) {\r\n                return sd.getTime() + (this.video.currentTime * 1000);\r\n            }\r\n        }\r\n\r\n        return 0;\r\n    }\r\n\r\n    destroy() {\r\n        if (this.hls) {\r\n            this.hls.destroy();\r\n            this.hls = null;\r\n        }\r\n        if (this.video) {\r\n            this.video.pause();\r\n            this.video.removeAttribute('src');\r\n            this.video.load();\r\n        }\r\n    }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}