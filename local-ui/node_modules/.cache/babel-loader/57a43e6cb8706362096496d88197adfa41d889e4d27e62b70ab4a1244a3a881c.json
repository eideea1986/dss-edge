{"ast":null,"code":"import _objectSpread from\"I:/dispecerat/github_release/dss-edge/local-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useEffect,useRef,useState}from'react';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function Go2RTCPlayer(_ref){let{camId,streamType='hd',style,onClick,onDoubleClick,isHidden}=_ref;const videoRef=useRef(null);const pcRef=useRef(null);const[status,setStatus]=useState(\"init\");// Fallback State: If 'low' fails, switch to 'hd'\nconst[activeStreamType,setActiveStreamType]=useState(streamType);const[useMjpeg,setUseMjpeg]=useState(false);// Reset fallback if the requested streamType changes from props\nuseEffect(()=>{setActiveStreamType(streamType);setUseMjpeg(false);},[streamType]);useEffect(()=>{if(useMjpeg)return;// FIX: Match the exact stream name registered by startStream.js\n// We currently register just the camId without _hd/_sub suffixes\nconst streamName=\"\".concat(camId,\"_\").concat(activeStreamType);const connectWebRTC=async()=>{setStatus(\"connecting\");if(pcRef.current)pcRef.current.close();const pc=new RTCPeerConnection({iceServers:[{urls:\"stun:stun.l.google.com:19302\"}]});pcRef.current=pc;pc.ontrack=event=>{if(videoRef.current){videoRef.current.srcObject=event.streams[0];// play() returns promise, handle rejection\nvideoRef.current.play().catch(e=>{console.warn(\"Autoplay failed\",e);});setStatus(\"playing\");}};pc.addTransceiver('video',{direction:'recvonly'});try{const offer=await pc.createOffer();await pc.setLocalDescription(offer);const apiUrl=\"/rtc/api/webrtc?src=\".concat(streamName);const res=await fetch(apiUrl,{method:'POST',body:pc.localDescription.sdp});if(!res.ok)throw new Error(\"Go2RTC Error: \".concat(res.status));const answerSdp=await res.text();if(pcRef.current&&pcRef.current.signalingState!=='closed'){await pc.setRemoteDescription(new RTCSessionDescription({type:'answer',sdp:answerSdp}));}}catch(e){console.warn(\"[Go2RTC] Failed to connect \".concat(streamName,\":\"),e);// Fallback Logic\nif(activeStreamType==='low'||activeStreamType==='sub'){// Covers both\nconsole.log(\"[Go2RTC] Substream failed, trying Main...\");setActiveStreamType('hd');}else if(!useMjpeg){// If both failed, fallback to MJPEG\nconsole.log(\"[Go2RTC] WebRTC failed completely, switching to MJPEG.\");setUseMjpeg(true);}}};if(camId)connectWebRTC();return()=>{if(pcRef.current){pcRef.current.close();pcRef.current=null;}};},[camId,activeStreamType,useMjpeg]);return/*#__PURE__*/_jsxs(\"div\",{style:_objectSpread(_objectSpread({},style),{},{position:\"relative\",background:\"#000\",overflow:\"hidden\"}),onClick:onClick,onDoubleClick:onDoubleClick,children:[useMjpeg?/*#__PURE__*/_jsx(\"img\",{src:\"/rtc/api/stream.mjpeg?src=\".concat(camId),style:{width:\"100%\",height:\"100%\",objectFit:\"cover\",display:\"block\"},alt:\"Live Stream\"}):/*#__PURE__*/_jsx(\"video\",{ref:videoRef,style:{width:\"100%\",height:\"100%\",objectFit:\"cover\",display:\"block\"},playsInline:true,muted:true,autoPlay:true}),status!=='playing'&&status!=='init'&&!useMjpeg&&/*#__PURE__*/_jsx(\"div\",{style:{position:\"absolute\",top:0,left:0,width:\"100%\",height:\"100%\",display:\"flex\",alignItems:\"center\",justifyContent:\"center\",color:\"rgba(255,255,255,0.5)\",fontSize:12,pointerEvents:\"none\"},children:status==='connecting'?'Connecting...':''})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","jsx","_jsx","jsxs","_jsxs","Go2RTCPlayer","_ref","camId","streamType","style","onClick","onDoubleClick","isHidden","videoRef","pcRef","status","setStatus","activeStreamType","setActiveStreamType","useMjpeg","setUseMjpeg","streamName","concat","connectWebRTC","current","close","pc","RTCPeerConnection","iceServers","urls","ontrack","event","srcObject","streams","play","catch","e","console","warn","addTransceiver","direction","offer","createOffer","setLocalDescription","apiUrl","res","fetch","method","body","localDescription","sdp","ok","Error","answerSdp","text","signalingState","setRemoteDescription","RTCSessionDescription","type","log","_objectSpread","position","background","overflow","children","src","width","height","objectFit","display","alt","ref","playsInline","muted","autoPlay","top","left","alignItems","justifyContent","color","fontSize","pointerEvents"],"sources":["I:/dispecerat/github_release/dss-edge/local-ui/src/components/Go2RTCPlayer.js"],"sourcesContent":["import React, { useEffect, useRef, useState } from 'react';\r\n\r\nexport default function Go2RTCPlayer({ camId, streamType = 'hd', style, onClick, onDoubleClick, isHidden }) {\r\n    const videoRef = useRef(null);\r\n    const pcRef = useRef(null);\r\n    const [status, setStatus] = useState(\"init\");\r\n\r\n    // Fallback State: If 'low' fails, switch to 'hd'\r\n    const [activeStreamType, setActiveStreamType] = useState(streamType);\r\n    const [useMjpeg, setUseMjpeg] = useState(false);\r\n\r\n    // Reset fallback if the requested streamType changes from props\r\n    useEffect(() => {\r\n        setActiveStreamType(streamType);\r\n        setUseMjpeg(false);\r\n    }, [streamType]);\r\n\r\n    useEffect(() => {\r\n        if (useMjpeg) return;\r\n\r\n        // FIX: Match the exact stream name registered by startStream.js\r\n        // We currently register just the camId without _hd/_sub suffixes\r\n        const streamName = `${camId}_${activeStreamType}`;\r\n\r\n        const connectWebRTC = async () => {\r\n            setStatus(\"connecting\");\r\n            if (pcRef.current) pcRef.current.close();\r\n\r\n            const pc = new RTCPeerConnection({\r\n                iceServers: [{ urls: \"stun:stun.l.google.com:19302\" }]\r\n            });\r\n            pcRef.current = pc;\r\n\r\n            pc.ontrack = (event) => {\r\n                if (videoRef.current) {\r\n                    videoRef.current.srcObject = event.streams[0];\r\n                    // play() returns promise, handle rejection\r\n                    videoRef.current.play().catch(e => {\r\n                        console.warn(\"Autoplay failed\", e);\r\n                    });\r\n                    setStatus(\"playing\");\r\n                }\r\n            };\r\n\r\n            pc.addTransceiver('video', { direction: 'recvonly' });\r\n\r\n            try {\r\n                const offer = await pc.createOffer();\r\n                await pc.setLocalDescription(offer);\r\n\r\n                const apiUrl = `/rtc/api/webrtc?src=${streamName}`;\r\n                const res = await fetch(apiUrl, { method: 'POST', body: pc.localDescription.sdp });\r\n\r\n                if (!res.ok) throw new Error(`Go2RTC Error: ${res.status}`);\r\n\r\n                const answerSdp = await res.text();\r\n                if (pcRef.current && pcRef.current.signalingState !== 'closed') {\r\n                    await pc.setRemoteDescription(new RTCSessionDescription({ type: 'answer', sdp: answerSdp }));\r\n                }\r\n            } catch (e) {\r\n                console.warn(`[Go2RTC] Failed to connect ${streamName}:`, e);\r\n                // Fallback Logic\r\n                if (activeStreamType === 'low' || activeStreamType === 'sub') { // Covers both\r\n                    console.log(`[Go2RTC] Substream failed, trying Main...`);\r\n                    setActiveStreamType('hd');\r\n                } else if (!useMjpeg) {\r\n                    // If both failed, fallback to MJPEG\r\n                    console.log(`[Go2RTC] WebRTC failed completely, switching to MJPEG.`);\r\n                    setUseMjpeg(true);\r\n                }\r\n            }\r\n        };\r\n\r\n        if (camId) connectWebRTC();\r\n\r\n        return () => {\r\n            if (pcRef.current) { pcRef.current.close(); pcRef.current = null; }\r\n        };\r\n    }, [camId, activeStreamType, useMjpeg]);\r\n\r\n    return (\r\n        <div style={{ ...style, position: \"relative\", background: \"#000\", overflow: \"hidden\" }}\r\n            onClick={onClick}\r\n            onDoubleClick={onDoubleClick}\r\n        >\r\n            {useMjpeg ? (\r\n                <img\r\n                    src={`/rtc/api/stream.mjpeg?src=${camId}`}\r\n                    style={{ width: \"100%\", height: \"100%\", objectFit: \"cover\", display: \"block\" }}\r\n                    alt=\"Live Stream\"\r\n                />\r\n            ) : (\r\n                <video\r\n                    ref={videoRef}\r\n                    style={{ width: \"100%\", height: \"100%\", objectFit: \"cover\", display: \"block\" }}\r\n                    playsInline\r\n                    muted\r\n                    autoPlay\r\n                />\r\n            )}\r\n\r\n            {status !== 'playing' && status !== 'init' && !useMjpeg && (\r\n                <div style={{\r\n                    position: \"absolute\", top: 0, left: 0, width: \"100%\", height: \"100%\",\r\n                    display: \"flex\", alignItems: \"center\", justifyContent: \"center\",\r\n                    color: \"rgba(255,255,255,0.5)\", fontSize: 12, pointerEvents: \"none\"\r\n                }}>\r\n                    {status === 'connecting' ? 'Connecting...' : ''}\r\n                </div>\r\n            )}\r\n        </div>\r\n    );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}