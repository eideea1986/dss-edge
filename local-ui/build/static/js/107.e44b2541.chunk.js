"use strict";(self.webpackChunkdss_edge_ui=self.webpackChunkdss_edge_ui||[]).push([[107],{107(e,t,r){r.r(t),r.d(t,{default:()=>f});var n=r(555),i=r(43),s=r(768);class o{constructor(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"/api";this.video=e,this.camId=t,this.baseUrl=r,this.mediaSource=null,this.sourceBuffer=null,this.queue=[],this.isAppending=!1,this.isPlaying=!1,this.manifest=null,this.currentIndex=-1,this.currentEpochMs=0,this.abortController=null}async play(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(!this.isPlaying){this.isPlaying=!0,console.log("[MSE] Starting play for ".concat(this.camId," at ").concat(e));try{const t=e||Date.now()-6e4,r="".concat(this.baseUrl,"/playback/playlist/").concat(this.camId,"?start=").concat(t);this.abortController=new AbortController;const n=await fetch(r,{signal:this.abortController.signal});if(!n.ok)throw new Error("HTTP ".concat(n.status));const i=await n.text();if(i.trim().startsWith("<"))throw console.error("[MSE] Received HTML instead of JSON manifest. Routing error?"),new Error("API returned HTML (fallback)");if(this.manifest=JSON.parse(i),!this.manifest.segments||!this.manifest.segments.length)return console.warn("[MSE] No segments found"),void(this.isPlaying=!1);this.currentIndex=0,this._initMSE()}catch(t){if("AbortError"===t.name)return;console.error("[MSE] Play failed:",t),this.isPlaying=!1}}}_initMSE(){this.mediaSource&&(this.video.src="",this.mediaSource=null),this.mediaSource=new MediaSource,this.video.src=URL.createObjectURL(this.mediaSource),this.mediaSource.addEventListener("sourceopen",()=>{console.log("[MSE] SourceOpen"),this.sourceBuffer=this.mediaSource.addSourceBuffer('video/mp4; codecs="avc1.42E01E"'),this.sourceBuffer.mode="sequence",this.sourceBuffer.addEventListener("updateend",()=>{this.isAppending=!1,this._processQueue()}),this.sourceBuffer.addEventListener("error",e=>{console.error("[MSE] SourceBuffer Error",e)}),this._loadNext()})}async _loadNext(){var e;if(!this.isPlaying||!this.manifest||this.currentIndex>=this.manifest.segments.length)return void(this.currentIndex>=this.manifest.segments.length&&"open"===(null===(e=this.mediaSource)||void 0===e?void 0:e.readyState)&&console.log("[MSE] No more segments, closing stream"));const t=this.manifest.segments[this.currentIndex];this.currentIndex++;try{var r;const e=await fetch(t.url,{signal:null===(r=this.abortController)||void 0===r?void 0:r.signal});if(!e.ok)throw new Error("Segment fetch failed: ".concat(e.status));const n=await e.arrayBuffer(),i=new Uint8Array(n.slice(0,10)),s=String.fromCharCode(...i);if(s.includes("<html")||s.includes("<!DOC"))throw new Error("Segment data is HTML (routing error)");this.queue.push({data:n,start_ts:t.start_ts}),this._processQueue(),this.queue.length<5&&this._loadNext()}catch(n){"AbortError"!==n.name&&(console.error("[MSE] Segment load error:",n),setTimeout(()=>this._loadNext(),1e3))}}_processQueue(){if(this.isAppending||0===this.queue.length||!this.sourceBuffer||this.sourceBuffer.updating)return;this.isAppending=!0;const e=this.queue.shift();try{this.sourceBuffer.appendBuffer(e.data),this.currentEpochMs=e.start_ts,this.video.paused&&this.isPlaying&&this.video.play().catch(e=>{"NotAllowedError"!==e.name&&console.warn("[MSE] Auto-play blocked",e)})}catch(t){if(console.error("[MSE] AppendBuffer failed:",t),this.isAppending=!1,"QuotaExceededError"===t.name){console.warn("[MSE] Buffer Full, clearing...");const e=0,t=this.video.currentTime-10;t>e&&this.sourceBuffer.remove(e,t)}}}seek(e){console.log("[MSE] Seek to ".concat(e)),this.stop(),this.play(e)}pause(){console.log("[MSE] Pause"),this.video.pause()}stop(){if(console.log("[MSE] Stop/Reset"),this.isPlaying=!1,this.abortController&&(this.abortController.abort(),this.abortController=null),this.queue=[],this.currentIndex=-1,this.manifest=null,this.isAppending=!1,this.sourceBuffer){try{this.sourceBuffer.updating||this.sourceBuffer.abort()}catch(e){}this.sourceBuffer=null}if(this.mediaSource){try{"open"===this.mediaSource.readyState&&this.mediaSource.endOfStream()}catch(e){}this.mediaSource=null}this.video&&(this.video.pause(),this.video.src="",this.video.load())}getCurrentEpochMs(){return this.currentEpochMs?this.currentEpochMs+1e3*this.video.currentTime:0}destroy(){this.stop()}}class a extends o{}var c=r(28);var l=r(579);const d=864e5,u=36e5,h=6e4,f=()=>{const e=new URLSearchParams(window.location.hash.split("?")[1]).get("camId"),[t,r]=(0,i.useState)([]),[o,f]=(0,i.useState)(e?[e]:[]),[p,g]=(0,i.useState)([]),[m,y]=(0,i.useState)((new Date).toISOString().split("T")[0]),[x,v]=(0,i.useState)(!1),[S,b]=(0,i.useState)(null),[w,E]=(0,i.useState)(0),[k,M]=(0,i.useState)(0),[j,C]=(0,i.useState)(1),[R,A]=(0,i.useState)(0),[T,B]=(0,i.useState)(null),I=(0,i.useRef)({}),_=(0,i.useRef)({}),P=(0,i.useRef)(null),D=(0,i.useRef)(!1),O=(0,i.useRef)(null),L=(0,i.useRef)(0);(0,i.useEffect)(()=>{const e=()=>{s.Ay.get("/system/time").then(e=>{var t,r,n,i;if(null!==(t=e.data)&&void 0!==t&&null!==(r=t.raw)&&void 0!==r&&r["Time zone"]){const t=e.data.raw["Time zone"].split(" ")[0];b(t)}null!==(n=e.data)&&void 0!==n&&n.epoch?E(e.data.epoch):null!==(i=e.data)&&void 0!==i&&i.iso?E(new Date(e.data.iso).getTime()):E(Date.now())}).catch(()=>{E(Date.now())})};e();const t=setInterval(e,6e4);return()=>clearInterval(t)},[]),(0,i.useEffect)(()=>{if(!w)return;const e=w,t=performance.now(),r=()=>{const n=performance.now()-t;E(e+n),O.current=requestAnimationFrame(r)};return O.current=requestAnimationFrame(r),()=>{O.current&&cancelAnimationFrame(O.current)}},[]),(0,i.useEffect)(()=>{if(!S)return;const e=(t=m,(r=S)?c.c9.fromISO(t,{zone:r}).startOf("day").toMillis():c.c9.fromISO(t).startOf("day").toMillis());var t,r;M(e),A(0),D.current=!1},[m,S]);const z=e=>function(e,t){if(!e)return"--:--:--";const r=t?{zone:t}:{};return c.c9.fromMillis(e,r).toFormat("HH:mm:ss")}(e,S),q=()=>d/j,F=(0,i.useCallback)((e,t)=>{const r=q();return(e-R)/r*t},[j,R]),U=(0,i.useCallback)((e,t)=>{const r=q();return R+e/t*r},[j,R]);(0,i.useEffect)(()=>{s.Ay.get("/cameras").then(e=>{r(e.data),0===o.length&&e.data.length>0&&f([e.data[0].id])}).catch(console.error)},[]),(0,i.useEffect)(()=>{0!==o.length&&s.Ay.get("/playback/timeline-day/".concat(o[0],"/").concat(m,"?_ts=").concat(Date.now())).then(e=>{g(e.data.segments||[])}).catch(console.error)},[o,m]),(0,i.useEffect)(()=>{o.forEach(e=>{if(!I.current[e]&&_.current[e]){const t=(s.Ay.defaults.baseURL||"/api").replace(/\/$/,"");I.current[e]=new a(_.current[e],e,t)}}),Object.keys(I.current).forEach(e=>{o.includes(e)||(I.current[e].destroy(),delete I.current[e])})},[o]),(0,i.useEffect)(()=>()=>{console.log("[Playback] Unmounting, stopping all players"),Object.values(I.current).forEach(e=>{e&&(e.stop(),e.destroy())}),I.current={}},[]),(0,i.useEffect)(()=>{D.current||0!==o.length&&0!==p.length&&(o.forEach(e=>{I.current[e]&&I.current[e].play()}),D.current=!0,v(!0))},[o,p]),(0,i.useEffect)(()=>{const e=setInterval(()=>{if(0===o.length||!k)return;const e=I.current[o[0]];if(!e)return;const t=e.getCurrentEpochMs();t>0&&B(t-k)},500);return()=>clearInterval(e)},[k,o]);const N=e=>{console.log("[UI] User SEEK to ".concat(new Date(e).toLocaleTimeString())),o.forEach(t=>{I.current[t]&&I.current[t].seek(e)}),B(e-k),v(!0)},W=e=>{if(null===T||!k)return;N(k+T+1e3*e)},H=(0,i.useCallback)(()=>{const e=P.current;if(!e||!k)return;const t=e.getContext("2d"),r=e.width,n=e.height,i=q();t.fillStyle="#0a0a0a",t.fillRect(0,0,r,n);const s=i/r;let o;o=s<1e3?h:s<5e3?3e5:s<15e3?9e5:s<6e4?u:72e5;const a=Math.floor(R/o)*o;t.font="10px monospace";for(let l=a;l<=R+i;l+=o){const e=F(l,r);if(e<0||e>r)continue;const i=l%u===0;if(t.strokeStyle=i?"#333":"#1a1a1a",t.lineWidth=1,t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke(),i||o<=3e5){const r=Math.floor(l/u),n=Math.floor(l%u/h),i="".concat(r.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"));t.fillStyle="#666",t.fillText(i,e+2,10)}}t.fillStyle="#2ecc71",p.forEach(e=>{const i=e.start_ts-k,s=e.end_ts-k,o=F(i,r),a=F(s,r);if(a>=0&&o<=r){const e=Math.max(0,o),i=Math.min(r,a);t.fillRect(e,n-14,i-e,14)}});const c=w-k;if(c>=0&&c<=d){const e=F(c,r);e>=0&&e<=r&&(t.strokeStyle="#3498db",t.lineWidth=1,t.setLineDash([3,3]),t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke(),t.setLineDash([]),t.fillStyle="#3498db",t.font="9px sans-serif",t.fillText("NOW",e+2,n-16))}if(null!==T){const e=F(T,r);if(e>=0&&e<=r){t.strokeStyle="#e74c3c",t.lineWidth=2,t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke(),t.fillStyle="#e74c3c",t.font="bold 10px monospace";const r=z(k+T);t.fillText(r,e+4,22)}}},[k,w,p,T,j,R,F,S]);(0,i.useEffect)(()=>{let e;const t=()=>{const r=performance.now();r-L.current>50&&(H(),L.current=r),e=requestAnimationFrame(t)};return e=requestAnimationFrame(t),()=>cancelAnimationFrame(e)},[H]);const Q={padding:"6px 12px",background:"#222",color:"#fff",border:"1px solid #333",borderRadius:4,cursor:"pointer",fontSize:12},J=(0,n.A)((0,n.A)({},Q),{},{background:"#2ecc71",borderColor:"#27ae60"});return(0,l.jsxs)("div",{style:{height:"calc(100vh - 64px)",display:"flex",flexDirection:"row",background:"#0a0a0a",color:"#eee",overflow:"hidden"},children:[(0,l.jsxs)("div",{style:{width:260,minWidth:260,background:"#111",borderRight:"1px solid #1a1a1a",display:"flex",flexDirection:"column",overflow:"hidden"},children:[(0,l.jsx)("div",{style:{padding:"12px",borderBottom:"1px solid #1a1a1a"},children:(0,l.jsxs)("div",{style:{fontSize:10,color:"#555",textTransform:"uppercase",letterSpacing:1},children:["Cameras (",o.length,")"]})}),(0,l.jsx)("div",{style:{flex:1,overflowY:"auto",padding:"8px"},children:t.map(e=>{const t=o.includes(e.id);return(0,l.jsxs)("div",{onClick:()=>{return t=e.id,o.includes(t)?f(o.filter(e=>e!==t)):f([...o,t]),void(D.current=!1);var t},style:{padding:"10px 12px",marginBottom:4,background:t?"rgba(46, 204, 113, 0.1)":"#151515",border:"1px solid ".concat(t?"#2ecc71":"#1a1a1a"),borderRadius:6,cursor:"pointer",display:"flex",alignItems:"center",gap:10},children:[(0,l.jsx)("div",{style:{width:8,height:8,borderRadius:"50%",background:t?"#2ecc71":"#333"}}),(0,l.jsx)("div",{style:{flex:1,minWidth:0},children:(0,l.jsx)("div",{style:{fontSize:12,fontWeight:t?600:400,color:t?"#2ecc71":"#888",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:e.name||e.id})})]},e.id)})}),(0,l.jsxs)("div",{style:{padding:"12px",borderTop:"1px solid #1a1a1a"},children:[(0,l.jsx)("div",{style:{fontSize:9,color:"#444",marginBottom:6},children:"DATE"}),(0,l.jsx)("input",{type:"date",value:m,onChange:e=>y(e.target.value),style:{width:"100%",padding:"8px",background:"#1a1a1a",color:"#fff",border:"1px solid #222",borderRadius:4,fontSize:12}}),(0,l.jsxs)("div",{style:{fontSize:9,color:"#444",marginTop:8},children:["VM Time: ",S||"syncing..."]})]})]}),(0,l.jsxs)("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden",padding:12},children:[(0,l.jsx)("div",{style:{flex:1,minHeight:0,display:"grid",gridTemplateColumns:o.length>1?"repeat(2, 1fr)":"1fr",gridTemplateRows:o.length>2?"repeat(2, 1fr)":"1fr",gap:4,background:"#000",borderRadius:6,padding:4,marginBottom:10},children:0===o.length?(0,l.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",color:"#333"},children:"Select cameras from sidebar"}):o.map(e=>{var r;return(0,l.jsxs)("div",{style:{position:"relative",background:"#0a0a0a",borderRadius:4,overflow:"hidden",display:"flex",alignItems:"center",justifyContent:"center"},children:[(0,l.jsx)("video",{ref:t=>_.current[e]=t,autoPlay:!0,playsInline:!0,muted:!0,style:{width:"100%",height:"100%",objectFit:"contain"}}),(0,l.jsx)("div",{style:{position:"absolute",top:4,left:4,background:"rgba(0,0,0,0.8)",padding:"2px 8px",borderRadius:4,fontSize:10},children:(null===(r=t.find(t=>t.id===e))||void 0===r?void 0:r.name)||e})]},e)})}),(0,l.jsx)("div",{style:{width:"100%",height:48,border:"1px solid #1a1a1a",borderRadius:4,overflow:"hidden",background:"#0a0a0a",marginBottom:10},children:(0,l.jsx)("canvas",{ref:P,width:2e3,height:48,style:{width:"100%",height:"100%",cursor:"crosshair"},onClick:e=>{const t=P.current;if(!t||!k)return;const r=t.getBoundingClientRect(),n=(e.clientX-r.left)*(t.width/r.width),i=U(n,t.width);N(k+i)},onWheel:e=>{e.preventDefault();const t=P.current;if(!t)return;const r=t.getBoundingClientRect(),n=(e.clientX-r.left)*(t.width/r.width),i=U(n,t.width),s=e.deltaY>0?.85:1.18,o=Math.max(1,Math.min(48,j*s)),a=d/o,c=i-n/t.width*a,l=Math.max(0,Math.min(d-a,c));C(o),A(l)}})}),(0,l.jsxs)("div",{style:{display:"flex",gap:6,alignItems:"center",background:"#111",padding:"8px 12px",borderRadius:4,border:"1px solid #1a1a1a"},children:[(0,l.jsx)("button",{onClick:()=>W(-30),style:Q,children:"-30s"}),(0,l.jsx)("button",{onClick:()=>W(-10),style:Q,children:"-10s"}),(0,l.jsx)("button",{onClick:()=>{o.forEach(e=>{I.current[e]&&I.current[e].stop()}),v(!1),D.current=!1},style:Q,children:"\u23f9"}),(0,l.jsx)("button",{onClick:x?()=>{o.forEach(e=>{I.current[e]&&I.current[e].pause()}),v(!1)}:()=>{o.forEach(e=>{I.current[e]&&I.current[e].play()}),v(!0)},style:x?J:Q,children:x?"\u23f8":"\u25b6"}),(0,l.jsx)("button",{onClick:()=>W(10),style:Q,children:"+10s"}),(0,l.jsx)("button",{onClick:()=>W(30),style:Q,children:"+30s"}),(0,l.jsx)("div",{style:{flex:1}}),(0,l.jsxs)("div",{style:{fontSize:10,color:"#555",marginRight:10},children:["Zoom: ",j.toFixed(1),"x"]}),(0,l.jsx)("div",{style:{fontSize:13,fontFamily:"monospace",color:"#2ecc71",background:"#0a0a0a",padding:"6px 12px",borderRadius:4,border:"1px solid #1a1a1a"},children:null!==T?z(k+T):"--:--:--"})]})]})]})}},768(e,t,r){r.d(t,{Ay:()=>o,nC:()=>s});var n=r(722);let i="";if("undefined"!==typeof window){const e=window.location.href.match(/(\/api\/proxy\/[^\/]+)/);e?i=e[1]:window.location.hash.includes("#/")&&(i="")}const s=n.A.create({baseURL:i}),o=s}}]);
//# sourceMappingURL=107.e44b2541.chunk.js.map