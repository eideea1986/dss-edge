"use strict";(self.webpackChunkdss_edge_ui=self.webpackChunkdss_edge_ui||[]).push([[870],{768(e,t,o){o.d(t,{Ay:()=>l,nC:()=>a});var n=o(722);let r="";if("undefined"!==typeof window){const e=window.location.href.match(/(\/api\/proxy\/[^\/]+)/);e?r=e[1]:window.location.hash.includes("#/")&&(r="")}const a=n.A.create({baseURL:r}),l=a},870(e,t,o){o.r(t),o.d(t,{default:()=>s});var n=o(43),r=o(768),a=o(579);const l=864e5,i=36e5,c=6e4,s=()=>{const e=new URLSearchParams(window.location.hash.split("?")[1]).get("camId"),[t,o]=(0,n.useState)([]),[s,d]=(0,n.useState)(e||""),[h,u]=(0,n.useState)([]),[f,g]=(0,n.useState)(0),[p,x]=(0,n.useState)((new Date).toISOString().split("T")[0]),[y,m]=(0,n.useState)({first:null,last:null}),[b,S]=(0,n.useState)(1),[v,w]=(0,n.useState)(0),[j,k]=(0,n.useState)(null),[R,C]=(0,n.useState)(null),M=(0,n.useRef)(null),T=(0,n.useRef)(null),D=(0,n.useRef)(0);(0,n.useEffect)(()=>{r.Ay.get("/cameras").then(e=>{o(e.data),!s&&e.data.length>0&&d(e.data[0].id)}).catch(e=>console.error("Cameras load error",e))},[s]),(0,n.useEffect)(()=>{s&&r.Ay.get("/playback/stats/".concat(s,"?_t=").concat(Date.now())).then(e=>m(e.data)).catch(console.error)},[s]),(0,n.useEffect)(()=>{s&&r.Ay.get("/playback/timeline-day/".concat(s,"/").concat(p,"?_ts=").concat(Date.now())).then(e=>{const{segments:t,dayStart:o}=e.data;g(o),u(t||[]),w(0),S(1)}).catch(e=>console.error("Timeline error",e))},[s,p]);const _=(e,t)=>(e-v)/(l/b)*t,A=(e,t)=>v+e/t*(l/b),E=(0,n.useCallback)(()=>{const e=T.current;if(!e||!f)return;const t=e.getContext("2d"),o=e.width,n=e.height,r=l/b;let a;t.fillStyle="#111",t.fillRect(0,0,o,n),a=r>432e5?i:r>108e5?18e5:r>36e5?6e5:6e4,t.lineWidth=1;for(let s=Math.floor(v/a)*a;s<v+r;s+=a){const e=_(s,o);if(!(e<0||e>o)&&(t.strokeStyle="#333",t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke(),s%i===0||r<144e5)){t.fillStyle="#888",t.font="10px Arial";const o=Math.floor(s/i),n=Math.floor(s%i/c);s>=0&&s<=l&&t.fillText("".concat(String(o).padStart(2,"0"),":").concat(String(n).padStart(2,"0")),e+2,12)}}if(t.fillStyle="#2ecc71",h.forEach(e=>{const n=Number(e.start_ts)-f,r=(0===e.end_ts?Date.now():Number(e.end_ts))-f,a=_(n,o),l=_(r,o),i=Math.max(l-a,1);a+i<0||a>o||t.fillRect(a,25,i,25)}),null!==j){const e=_(j,o);e>=0&&e<=o&&(t.strokeStyle="red",t.lineWidth=2,t.beginPath(),t.moveTo(e,0),t.lineTo(e,n),t.stroke(),t.fillStyle="red",t.beginPath(),t.moveTo(e-5,0),t.lineTo(e+5,0),t.lineTo(e,8),t.fill())}},[h,f,b,v,j]);(0,n.useEffect)(()=>{E()},[E]),(0,n.useEffect)(()=>{const e=setInterval(()=>{if(M.current&&!M.current.paused&&D.current>0){const e=D.current+1e3*M.current.currentTime;k(e-f)}},500);return()=>clearInterval(e)},[f]);const P=e=>{if(M.current){const t="".concat(r.Ay.defaults.baseURL,"/playback/stream/").concat(s,"?ts=").concat(e,"&_nocache=").concat(Date.now());console.log("[Player] Loading: ".concat(t)),D.current=e,M.current.src=t,M.current.load(),M.current.play().catch(e=>console.error("Play error:",e))}};return(0,a.jsxs)("div",{className:"playback-page",style:{padding:20,background:"#1a1a1a",color:"#eee",minHeight:"100vh"},children:[(0,a.jsxs)("div",{style:{marginBottom:15,display:"flex",gap:15,alignItems:"center",flexWrap:"wrap"},children:[(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,a.jsx)("label",{style:{fontSize:11,color:"#888"},children:"Camera"}),(0,a.jsx)("select",{value:s,onChange:e=>d(e.target.value),style:{padding:"6px 10px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:4},children:t.map(e=>(0,a.jsx)("option",{value:e.id,children:e.name||e.ip},e.id))})]}),(0,a.jsxs)("div",{style:{display:"flex",flexDirection:"column"},children:[(0,a.jsx)("label",{style:{fontSize:11,color:"#888"},children:"Date"}),(0,a.jsx)("input",{type:"date",value:p,onChange:e=>x(e.target.value),style:{padding:"5px 10px",background:"#333",color:"#fff",border:"1px solid #555",borderRadius:4}})]}),(0,a.jsx)("button",{onClick:()=>window.location.reload(),style:{marginTop:15,padding:"7px 15px",cursor:"pointer",background:"#2ecc71",color:"#000",border:"none",borderRadius:4,fontWeight:"bold"},children:"Refresh"}),(0,a.jsx)("div",{style:{flex:1}}),R&&(0,a.jsx)("div",{style:{color:"#f1c40f",fontWeight:"bold",fontSize:14,background:"rgba(0,0,0,0.3)",padding:"5px 15px",borderRadius:20},children:R}),y.first&&y.first>17e11&&(0,a.jsxs)("div",{style:{fontSize:12,color:"#2ecc71",textAlign:"right"},children:[(0,a.jsx)("div",{children:"Archive range:"}),(0,a.jsxs)("div",{style:{fontWeight:"bold"},children:[new Date(y.first).toLocaleString()," - ",new Date(y.last).toLocaleString()]})]})]}),(0,a.jsx)("div",{className:"video-container",style:{background:"#000",borderRadius:8,overflow:"hidden",boxShadow:"0 10px 30px rgba(0,0,0,0.5)",width:"100%",height:"65vh",marginBottom:15},children:(0,a.jsx)("video",{ref:M,id:"player",controls:!0,autoPlay:!0,style:{width:"100%",height:"100%"},onError:e=>console.error("Video element error:",e)})}),(0,a.jsx)("div",{className:"timeline-container",style:{width:"100%",height:80,position:"relative",border:"1px solid #333",borderRadius:4,overflow:"hidden"},children:(0,a.jsx)("canvas",{ref:T,id:"timeline",width:2e3,height:80,style:{width:"100%",height:"100%",cursor:"crosshair"},onClick:e=>{if(!f)return;const t=T.current.getBoundingClientRect(),o=e.clientX-t.left,n=A(o,t.width),r=Math.floor(f+n);k(n),C("Seeking to: ".concat(p," ").concat((e=>{const t=Math.floor(e/1e3),o=Math.floor(t/3600),n=Math.floor(t%3600/60),r=t%60;return"".concat(o.toString().padStart(2,"0"),":").concat(n.toString().padStart(2,"0"),":").concat(r.toString().padStart(2,"0"))})(n))),P(r)},onWheel:e=>{e.preventDefault();const t=T.current.getBoundingClientRect(),o=e.clientX-t.left,n=A(o,t.width);e.deltaY;let r=Math.min(100,Math.max(1,b*(e.deltaY>0?.8:1.2)));const a=l/r;let i=n-o/t.width*a;i=Math.max(.1*-a,Math.min(l-.9*a,i)),S(r),w(i)}})}),(0,a.jsxs)("div",{style:{marginTop:10,display:"flex",justifyContent:"space-between",color:"#666",fontSize:11},children:[(0,a.jsx)("div",{children:"* Use mouse wheel to ZOOM. Click to SEEK."}),(0,a.jsxs)("div",{children:["Zoom: ",b.toFixed(1),"x"]})]})]})}}}]);
//# sourceMappingURL=870.25b6b82f.chunk.js.map