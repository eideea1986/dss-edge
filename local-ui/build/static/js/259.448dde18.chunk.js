"use strict";(self.webpackChunkdss_edge_ui=self.webpackChunkdss_edge_ui||[]).push([[259],{259(t,e,s){s.r(e),s.d(e,{default:()=>S});var n=s(555),i=s(43),o=s(475),a=s(216),r=s(768),c=s(788);const l=Object.freeze({IDLE:"IDLE",LOADING:"LOADING",READY:"READY",PLAYING:"PLAYING",PAUSED:"PAUSED",BUFFERING:"BUFFERING",GAP:"GAP",ERROR:"ERROR"}),d=Object.freeze({LOAD_LIVE:"LOAD_LIVE",LOAD_PLAYBACK:"LOAD_PLAYBACK",METADATA_READY:"METADATA_READY",VIDEO_TRACK_READY:"VIDEO_TRACK_READY",PLAY:"PLAY",PAUSE:"PAUSE",SEEK:"SEEK",BUFFER_EMPTY:"BUFFER_EMPTY",BUFFER_FULL:"BUFFER_FULL",GAP_DETECTED:"GAP_DETECTED",GAP_RESOLVED:"GAP_RESOLVED",END:"END",ERROR:"ERROR",RESET:"RESET"});class h{constructor(t){let{onStateChange:e,onAction:s,logger:n=console}=t;this.state=l.IDLE,this.onStateChange=e,this.onAction=s,this.log=n}transition(t,e){this.log&&this.log.debug?this.log.debug("[PLAYER FSM] ".concat(this.state," -> ").concat(t),e||""):console.log("[PLAYER FSM] ".concat(this.state," -> ").concat(t),e||""),this.state=t,this.onStateChange&&this.onStateChange(t,e)}dispatch(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};switch(this.log&&this.log.debug&&this.log.debug("[PLAYER FSM EVENT] ".concat(t),e),this.state){case l.IDLE:t!==d.LOAD_LIVE&&t!==d.LOAD_PLAYBACK||(this.transition(l.LOADING,e),this.onAction&&this.onAction("initStream",e));break;case l.LOADING:if(t===d.METADATA_READY)return;t===d.VIDEO_TRACK_READY&&this.transition(l.READY),t===d.ERROR&&this.transition(l.ERROR,e);break;case l.READY:t===d.PLAY&&(this.transition(l.PLAYING),this.onAction&&this.onAction("play")),t===d.SEEK&&this.onAction&&this.onAction("seek",e),t===d.ERROR&&this.transition(l.ERROR,e);break;case l.PLAYING:t===d.PAUSE&&(this.transition(l.PAUSED),this.onAction&&this.onAction("pause")),t===d.BUFFER_EMPTY&&this.transition(l.BUFFERING),t===d.GAP_DETECTED&&(this.transition(l.GAP,e),this.onAction&&this.onAction("skipGap",e)),t===d.END&&this.transition(l.IDLE),t===d.ERROR&&this.transition(l.ERROR,e);break;case l.BUFFERING:t===d.BUFFER_FULL&&this.transition(l.PLAYING),t===d.GAP_DETECTED&&this.transition(l.GAP,e),t===d.ERROR&&this.transition(l.ERROR,e);break;case l.GAP:t===d.GAP_RESOLVED&&this.transition(l.BUFFERING),t===d.END&&this.transition(l.IDLE);break;case l.PAUSED:t===d.PLAY&&(this.transition(l.PLAYING),this.onAction&&this.onAction("play")),t===d.SEEK&&this.onAction&&this.onAction("seek",e);break;case l.ERROR:t===d.RESET&&this.transition(l.IDLE);break;default:console.error("Unknown state",this.state)}}}class u{constructor(t,e,s){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"/api";this.video=t,this.camId=e,this.baseUrl=n,this.segments=[],this.hls=null,this.fsm=new h({onStateChange:(t,e)=>{s&&s(t,e)},onAction:(t,e)=>this._handleAction(t,e)}),this._bindVideoEvents()}_bindVideoEvents(){this.video.addEventListener("waiting",()=>{this.fsm.dispatch(d.BUFFER_EMPTY)}),this.video.addEventListener("playing",()=>{this.fsm.dispatch(d.BUFFER_FULL)}),this.video.addEventListener("error",t=>{this.fsm.dispatch(d.ERROR,{error:t})}),this.video.addEventListener("timeupdate",()=>this._checkGap())}destroy(){this.hls&&(this.hls.destroy(),this.hls=null)}loadSegments(t){this.segments=(t||[]).map(t=>({start:Number(t.start||t.start_ts||t.startTs),end:Number(t.end||t.end_ts||t.endTs),file:t.file})).sort((t,e)=>t.start-e.start),this.segments.length>0&&(this.fsm.dispatch(d.LOAD_PLAYBACK,{camId:this.camId,segments:this.segments}),this.fsm.dispatch(d.METADATA_READY),this.fsm.dispatch(d.VIDEO_TRACK_READY))}seekTo(t){this.fsm.dispatch(d.SEEK,{time:t})}play(){this.fsm.dispatch(d.PLAY)}pause(){this.fsm.dispatch(d.PAUSE)}_handleAction(t,e){switch(console.log("[Controller] Executing Action: ".concat(t),e),t){case"initStream":break;case"play":this.video.play().catch(t=>console.warn("Play interrupted",t));break;case"pause":this.video.pause();break;case"seek":this._performSeek(e.time);break;case"skipGap":this._performSeek(e.nextSegment.start),this.fsm.dispatch(d.GAP_RESOLVED)}}_performSeek(t){console.log("[Controller] Seeking to ".concat(new Date(t).toLocaleTimeString()));const e=this.segments.find(e=>t>=e.start&&t<e.end);if(!e){const e=this.segments.find(e=>e.start>t);return void(e?(console.log("[Controller] Gap Detected during Seek."),this.fsm.dispatch(d.GAP_DETECTED,{nextSegment:e})):(console.log("[Controller] End of timeline."),this.fsm.dispatch(d.END)))}"".concat(this.baseUrl,"/playback/playlist/").concat(this.camId,"/").concat(e.start,".m3u8");const s="".concat(this.baseUrl,"/playback/playlist/").concat(this.camId,".m3u8?start=").concat(t,"&end=").concat(e.end);this.hls&&this.hls.destroy(),c.Ay.isSupported()&&(this.hls=new c.Ay,this.hls.loadSource(s),this.hls.attachMedia(this.video),this.hls.on(c.Ay.Events.MANIFEST_PARSED,()=>{this.video.currentTime=0,this.fsm.state!==l.PLAYING&&this.fsm.state!==l.BUFFERING||this.video.play()}),this.hls.on(c.Ay.Events.FRAG_CHANGED,(t,e)=>{this._currentFragTime=e.frag.programDateTime}))}_checkGap(){this.segments.length&&this._currentFragTime}getCurrentTime(){return this.hls&&this._currentFragTime?this._currentFragTime+1e3*this.video.currentTime%4e3:Date.now()}}var E=s(579);const p={background:"#444",color:"#fff",border:"none",padding:"4px 8px",borderRadius:3,cursor:"pointer"},f="#1e1e1e",g="#252526",A="#2d2d2d",R="#ffffff",m="#2196f3",D="#4caf50",b="#252526",v="#ff9800",y="#3e3e42",x="#37373d";function S(){var t;const[e]=(0,o.ok)(),s=(0,a.Zp)(),c=e.get("camId"),[d,h]=(0,i.useState)([]),[S,L]=(0,i.useState)((new Date).toISOString().split("T")[0]),[_,k]=(0,i.useState)(l.IDLE),[P,T]=(0,i.useState)(Date.now()),[I,w]=(0,i.useState)((new Date).setHours(0,0,0,0)),[F,G]=(0,i.useState)(1e3/86400),[Y,C]=(0,i.useState)(1e3),[O,N]=(0,i.useState)([]),[j,U]=(0,i.useState)(!1),B=(0,i.useRef)(null),M=(0,i.useRef)(null),V=(0,i.useRef)(null),z=(0,i.useRef)({isDragging:!1,startX:0,startViewTime:0}),[K,H]=(0,i.useState)({start:null,end:null});(0,i.useEffect)(()=>{r.Ay.get("/cameras").then(t=>{const e=Array.isArray(t.data)?t.data:[];h(e)}).catch(console.error)},[]),(0,i.useEffect)(()=>{c&&r.Ay.get("/api/playback/range/".concat(c)).then(t=>{H(t.data)}).catch(console.error)},[c]),(0,i.useEffect)(()=>{if(S){const t=new Date(S).setHours(0,0,0,0);w(t),T(t+432e5)}},[S]),(0,i.useLayoutEffect)(()=>{if(!V.current)return;const t=new ResizeObserver(t=>{for(let e of t)e.contentRect.width>0&&C(e.contentRect.width)});return t.observe(V.current),C(V.current.clientWidth||1e3),()=>t.disconnect()},[]),(0,i.useEffect)(()=>{if(B.current&&c)return M.current=new u(B.current,c,t=>k(t)),()=>{var t;return null===(t=M.current)||void 0===t?void 0:t.destroy()}},[c]),(0,i.useEffect)(()=>{if(!c||!S)return;(async()=>{U(!0),N([]);try{const t=(await r.Ay.get("/api/playback/timeline-day/".concat(c,"/").concat(S))).data,e=t.dayStart,s=new Date(S).setHours(0,0,0,0);let n=0;e>0&&(n=s-e);const i=(t.segments||[]).map(t=>({start:Number(t.start_ts)+n,end:Number(t.end_ts)+n,type:"normal"})).sort((t,e)=>t.start-e.start);N(i),M.current&&M.current.loadSegments(i),w(s),Y>0&&G(Y/86400)}catch(t){console.error(t)}finally{U(!1)}})()},[c,S,Y]),(0,i.useEffect)(()=>{const t=setInterval(()=>{if(_===l.PLAYING&&M.current){const t=M.current.getCurrentTime();Math.abs(t-P)>200&&T(t);const e=O.find(e=>t>=e.start&&t<e.end);if(e&&e.end-t<500){const t=O.find(t=>t.start>=e.end);t&&t.start-e.end>1e3&&M.current.seekTo(t.start)}}},100);return()=>clearInterval(t)},[_,P,O]);const X=t=>{var e;T(t),null===(e=M.current)||void 0===e||e.seekTo(t)},W=t=>{if(z.current.isDragging=!1,Math.abs(t.clientX-z.current.startX)<5){const e=V.current.getBoundingClientRect(),s=t.clientX-e.left;X(I+s/F*1e3)}},Z=t=>(t-I)/1e3*F;return(0,E.jsxs)("div",{style:{display:"flex",width:"100%",height:"100%",background:f,color:R},children:[(0,E.jsxs)("div",{style:{width:250,background:g,borderSizing:"border-box",borderRight:"1px solid ".concat(y),display:"flex",flexDirection:"column"},children:[(0,E.jsx)("div",{style:{padding:"12px 16px",fontWeight:"bold",borderBottom:"1px solid ".concat(y),color:m,fontSize:12,letterSpacing:1},children:"CHANNELS"}),(0,E.jsxs)("div",{style:{flex:1,overflowY:"auto"},children:[d.map(t=>(0,E.jsx)("div",{onClick:()=>{return e=t.id,void s("/playback?camId=".concat(e));var e},style:{padding:"10px 16px",cursor:"pointer",fontSize:13,borderBottom:"1px solid rgba(255,255,255,0.02)",background:c===t.id?x:"transparent",color:c===t.id?m:"#aaa",borderLeft:c===t.id?"3px solid ".concat(m):"3px solid transparent"},children:t.name||t.id},t.id)),0===d.length&&(0,E.jsx)("div",{style:{padding:10,color:"#888"},children:"No cameras found"})]})]}),(0,E.jsxs)("div",{style:{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"},children:[(0,E.jsxs)("header",{style:{height:44,background:A,display:"flex",alignItems:"center",padding:"0 12px",borderBottom:"1px solid ".concat(y),gap:15},children:[(0,E.jsx)("button",{onClick:()=>s("/live"),style:(0,n.A)((0,n.A)({},p),{},{background:"transparent",padding:"4px 8px",fontSize:16}),title:"Back to Live",children:"\u2b05\ufe0f"}),(0,E.jsx)("span",{style:{fontWeight:"bold",color:m,fontSize:14},children:"ARHIV\u0102 VMS"}),c&&(0,E.jsx)("span",{style:{fontSize:13,background:"rgba(255,255,255,0.05)",padding:"2px 8px",borderRadius:4},children:(null===(t=d.find(t=>t.id===c))||void 0===t?void 0:t.name)||c}),K.start&&(0,E.jsxs)("span",{style:{fontSize:11,color:"#888"},children:["(",new Date(K.start).toLocaleDateString()," - ",new Date(K.end).toLocaleDateString(),")"]}),(0,E.jsx)("div",{style:{flex:1}}),(0,E.jsx)("input",{type:"date",value:S,onChange:t=>L(t.target.value),style:{background:"#333",color:"#fff",border:"1px solid #444",borderRadius:4,padding:"4px 8px",fontSize:12}})]}),(0,E.jsxs)("div",{style:{flex:1,position:"relative",background:"#000",overflow:"hidden",minHeight:0},children:[(0,E.jsx)("video",{ref:B,style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",objectFit:"contain"}}),!c&&(0,E.jsx)("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",color:"#aaa"},children:"Select a Camera"})]}),(0,E.jsxs)("div",{style:{height:48,background:"#252526",display:"flex",alignItems:"center",padding:"0 10px",gap:10},children:[(0,E.jsx)("button",{style:p,onClick:()=>X(P-5e3),children:"\u23ea"}),(0,E.jsx)("button",{style:p,onClick:()=>{var t,e;return _===l.PLAYING?null===(t=M.current)||void 0===t?void 0:t.pause():null===(e=M.current)||void 0===e?void 0:e.play()},children:_===l.PLAYING?"PAUSE":"PLAY"}),(0,E.jsx)("button",{style:p,onClick:()=>X(P+5e3),children:"\u23e9"}),(0,E.jsx)("span",{style:{flex:1,textAlign:"center",fontFamily:"monospace"},children:new Date(P).toLocaleTimeString()}),(0,E.jsx)("button",{style:p,onClick:()=>{const t=new Date(S).setHours(0,0,0,0);w(t),G(Y/86400)},children:"24H"})]}),(0,E.jsxs)("div",{className:"timeline-area",ref:V,style:{height:100,background:b,position:"relative",overflow:"hidden"},onMouseUp:W,onMouseLeave:W,onMouseMove:t=>{if(!z.current.isDragging)return;const e=-(t.clientX-z.current.startX)/F*1e3;let s=z.current.startViewTime+e;const n=new Date(S).setHours(0,0,0,0);s<n&&(s=n),w(s)},onMouseDown:t=>{z.current={isDragging:!0,startX:t.clientX,startViewTime:I}},onWheel:t=>{if(t.target.closest(".timeline-area")){t.preventDefault();const e=V.current.getBoundingClientRect(),s=t.clientX-e.left,n=I+s/F*1e3,i=t.deltaY>0?.9:1.1,o=Math.max(Y/86400,Math.min(5,F*i));let a=n-s/o*1e3;const r=new Date(S).setHours(0,0,0,0);a<r&&(a=r),G(o),w(a)}},children:[(0,E.jsx)("div",{style:{height:25,borderBottom:"1px solid #444"},children:(()=>{const t=[],e=new Date(S).setHours(0,0,0,0);for(let s=0;s<=24;s++){const n=Z(e+36e5*s);n<-20||n>Y||t.push((0,E.jsx)("div",{style:{position:"absolute",left:n,top:0,height:25,borderLeft:"1px solid #666"},children:(0,E.jsxs)("div",{style:{position:"absolute",top:2,left:4,fontSize:11,color:"#aaa"},children:[s,":00"]})},s))}return t})()}),(0,E.jsx)("div",{style:{position:"relative",top:5,height:40},children:O.map((t,e)=>{const s=Z(t.start),n=Math.max(2,(t.end-t.start)/1e3*F);return s+n<0||s>Y?null:(0,E.jsx)("div",{style:{position:"absolute",left:s,width:n,height:"100%",background:D}},e)})}),(0,E.jsx)("div",{style:{position:"absolute",left:Z(P),top:0,bottom:0,width:2,background:v,zIndex:10}})]})]})]})}},768(t,e,s){s.d(e,{Ay:()=>a,nC:()=>o});var n=s(722);let i="";if("undefined"!==typeof window){const t=window.location.href.match(/(\/api\/proxy\/[^\/]+)/);t?i=t[1]:window.location.hash.includes("#/")&&(i="")}const o=n.A.create({baseURL:i}),a=o}}]);
//# sourceMappingURL=259.448dde18.chunk.js.map